<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lista de Materiales - Linda Herrer칤a</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="lindaherreriaMC2.png" />
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="modo-oscuro">

<h2>Lista de Materiales</h2>

<!-- Bot칩n de ordenamiento -->
<div id="menu-orden" class="trabajos-menu-custom">
  <button id="toggle-orden" class="boton-gris">Ordenar presupuestos</button>
  <div class="trabajos-lista hidden">
    <label><input type="radio" name="orden" value="nombre-asc" checked> Nombre A-Z</label>
    <label><input type="radio" name="orden" value="nombre-desc"> Nombre Z-A</label>
    <label><input type="radio" name="orden" value="fecha-asc"> Fecha ascendente</label>
    <label><input type="radio" name="orden" value="fecha-desc"> Fecha descendente</label>
  </div>
</div>

<div id="contenedor-presupuestos">
  <h3>Seleccion치 los presupuestos</h3>
  <button id="btn-identificar-antiguos" class="boton-naranja" style="margin-bottom: 1rem;">
    <i data-lucide="search"></i> Identificar presupuestos antiguos
  </button>
  <div id="presupuestos-antiguos" class="hidden">
    <h4 style="color: #e74c3c;">Presupuestos con formato antiguo:</h4>
    <ul id="lista-antiguos" style="margin-bottom: 1rem;"></ul>
    <button id="btn-eliminar-antiguos" class="boton-rojo">
      <i data-lucide="trash-2"></i> Eliminar todos los presupuestos antiguos
    </button>
  </div>
  <ul id="lista-presupuestos"></ul>
  <button id="btn-confirmar" class="boton-celeste">Confirmar selecci칩n</button>
</div>

<div id="contenedor-cantidades" class="hidden">
  <h3>Cantidades de presupuestos seleccionados</h3>
  <ul id="lista-cantidades"></ul>
  <button id="btn-generar" class="boton-verde">Generar lista de materiales</button>
</div>

<div id="resultado" class="hidden">
  <h3>Materiales necesarios</h3>
  <div id="lista-materiales"></div>
  <h3>Total: $<span id="total-materiales">0</span></h3>
  <button id="btn-compartir-lista" class="boton-verde" style="margin-top: 1rem;">
    <i data-lucide="share"></i> Compartir por WhatsApp
  </button>
</div>

<script type="module">
import { db } from './firebase-config.js';
import { collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const listaPresupuestos = document.getElementById('lista-presupuestos');
const btnConfirmar = document.getElementById('btn-confirmar');
const contenedorCantidades = document.getElementById('contenedor-cantidades');
const listaCantidades = document.getElementById('lista-cantidades');
const btnGenerar = document.getElementById('btn-generar');
const listaMateriales = document.getElementById('lista-materiales');
const resultado = document.getElementById('resultado');
const totalMateriales = document.getElementById('total-materiales');
const toggleOrdenBtn = document.getElementById('toggle-orden');
const listaOrden = document.querySelector('#menu-orden .trabajos-lista');

let presupuestos = [];
let materiales = [];
let ordenSeleccionado = 'nombre-asc';
let seleccionadosConCantidad = [];

async function cargarDatos() {
  const snapPresupuestos = await getDocs(collection(db, 'presupuestos'));
  const snapMateriales = await getDocs(collection(db, 'materiales'));

  presupuestos = snapPresupuestos.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  materiales = snapMateriales.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  console.log('Materiales cargados:', materiales);
  console.log('Presupuestos cargados:', presupuestos);

  renderPresupuestos();
}

function formatearMoneda(valor) {
  return Math.round(valor).toLocaleString('es-AR');
}

function renderPresupuestos() {
  let lista = [...presupuestos];

  lista.sort((a, b) => {
    if (ordenSeleccionado === 'nombre-asc') return a.nombre.localeCompare(b.nombre);
    if (ordenSeleccionado === 'nombre-desc') return b.nombre.localeCompare(a.nombre);
    if (ordenSeleccionado === 'fecha-asc') return new Date(a.fechaOrden) - new Date(b.fechaOrden);
    if (ordenSeleccionado === 'fecha-desc') return new Date(b.fechaOrden) - new Date(a.fechaOrden);
    return 0;
  });

  listaPresupuestos.innerHTML = lista.map(p => `
    <li>
      <label>
        <input type="checkbox" value="${p.id}">
        ${p.nombre} (${p.fecha})
      </label>
    </li>
  `).join('');
}

btnConfirmar.addEventListener('click', () => {
  const seleccionados = Array.from(listaPresupuestos.querySelectorAll('input:checked')).map(input => input.value);
  if (seleccionados.length === 0) {
    alert('Seleccion치 al menos un presupuesto.');
    return;
  }

  listaCantidades.innerHTML = seleccionados.map(id => {
    const presupuesto = presupuestos.find(p => p.id === id);
    return `
      <li class="item-presupuesto mini-controls" data-id="${id}">
        <strong>${presupuesto.nombre}</strong> (${presupuesto.fecha})<br>
        <div class="cantidad-controles">
          <button class="btn-mini boton-disminuir" data-id="${id}"><i data-lucide="square-minus"></i></button>
          <input type="number" min="1" value="1" class="input-cantidad" data-id="${id}">
          <button class="btn-mini boton-aumentar" data-id="${id}"><i data-lucide="square-plus"></i></button>
          <button class="btn-mini boton-eliminar" data-id="${id}"><i data-lucide="trash-2"></i></button>
        </div>
      </li>
    `;
  }).join('');

  // Configurar event listeners para los botones una sola vez
  listaCantidades.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const id = btn.dataset.id;
    const input = listaCantidades.querySelector(`input[data-id="${id}"]`);
    if (!input) return;

    if (btn.classList.contains('boton-aumentar')) {
      input.value = parseInt(input.value) + 1;
    } else if (btn.classList.contains('boton-disminuir')) {
      if (parseInt(input.value) > 1) {
        input.value = parseInt(input.value) - 1;
      }
    } else if (btn.classList.contains('boton-eliminar')) {
      if (confirm('쯉eguro que quer칠s eliminar este presupuesto de la selecci칩n?')) {
        btn.closest('li').remove();
      }
    }
  });

  contenedorCantidades.classList.remove('hidden');
  lucide.createIcons();
});

btnGenerar.addEventListener('click', () => {
  seleccionadosConCantidad = [];
  
  listaCantidades.querySelectorAll('input[type="number"]').forEach(input => {
    const id = input.dataset.id;
    const cantidad = parseInt(input.value) || 1;
    seleccionadosConCantidad.push({ id, cantidad });
  });

  generarListaMateriales();
});

function generarListaMateriales() {
  const materialesNecesarios = {};
  let total = 0;

  console.log('Presupuestos seleccionados:', seleccionadosConCantidad);

  // Acumulamos cantidades necesarias usando directamente los IDs
  seleccionadosConCantidad.forEach(({ id, cantidad }) => {
    const presupuesto = presupuestos.find(p => p.id === id);
    console.log('Procesando presupuesto:', presupuesto);
    if (!presupuesto) {
      console.warn('No se encontr칩 el presupuesto con ID:', id);
      return;
    }

    console.log('Items en el presupuesto:', presupuesto.items);
    presupuesto.items.forEach(item => {
      console.log('Procesando item:', item);
      if (!item.id) {
        console.warn(`Item sin ID encontrado en presupuesto ${presupuesto.id}: ${item.nombre}`);
        return;
      }

      const clave = item.id;
      if (!materialesNecesarios[clave]) {
        materialesNecesarios[clave] = {
          id: item.id,
          cantidad: 0,
          unidad: item.unidad
        };
      }
      materialesNecesarios[clave].cantidad += item.cantidad * cantidad;
    });
  });

  console.log('Materiales necesarios acumulados:', materialesNecesarios);

  // Agrupamos por categor칤a usando los IDs
  const materialesAgrupados = {};

  for (let clave in materialesNecesarios) {
    const item = materialesNecesarios[clave];
    const material = materiales.find(m => m.id === item.id);
    
    console.log('Buscando material con ID:', item.id);
    console.log('Material encontrado:', material);
    
    if (!material) {
      console.warn(`Material no encontrado con ID: ${item.id}`);
      continue;
    }

    const cantidadNecesaria = item.cantidad;
    const unidadesCompradas = Math.ceil(cantidadNecesaria / material.fraccionamiento);
    const subtotal = unidadesCompradas * material.precio;

    console.log('C치lculos para', material.nombre, ':', {
      cantidadNecesaria,
      unidadesCompradas,
      subtotal
    });

    const categoria = material.categoria?.toLowerCase() || 'otros';
    console.log('Categor칤a del material:', categoria);

    if (!materialesAgrupados[categoria]) {
      console.log('Creando nueva categor칤a:', categoria);
      materialesAgrupados[categoria] = [];
    }

    const materialAgrupado = {
      id: material.id,
      nombre: material.nombre,
      unidad: material.unidad || item.unidad,
      metrosNecesarios: cantidadNecesaria,
      unidades: unidadesCompradas,
      precio: material.precio,
      subtotal
    };
    console.log('Agregando material a la categor칤a:', materialAgrupado);
    materialesAgrupados[categoria].push(materialAgrupado);

    total += subtotal;
  }

  console.log('Materiales agrupados final:', materialesAgrupados);

  mostrarMateriales(materialesAgrupados);
  resultado.classList.remove('hidden');
  totalMateriales.textContent = formatearMoneda(total);
}

function generarMensajeWhatsApp(materialesAgrupados, total) {
  let mensaje = '游 *Lista de Materiales*\n\n';

  // Primero agregamos los presupuestos seleccionados
  mensaje += '*Presupuestos incluidos:*\n';
  seleccionadosConCantidad.forEach(({ id, cantidad }) => {
    const presupuesto = presupuestos.find(p => p.id === id);
    mensaje += `- ${presupuesto.nombre} (${cantidad} unidad${cantidad > 1 ? 'es' : ''})\n`;
  });

  mensaje += '\n*Materiales necesarios:*\n';
  
  // Luego agregamos los materiales por categor칤a
  ordenCategorias.forEach(cat => {
    if (materialesAgrupados[cat] && materialesAgrupados[cat].length > 0) {
      mensaje += `\n游닍 *${cat.charAt(0).toUpperCase() + cat.slice(1)}*\n`;
      materialesAgrupados[cat].forEach(m => {
        mensaje += `- ${m.nombre}: ${m.metrosNecesarios.toFixed(2)} ${m.unidad === 'metro' ? 'mt' : m.unidad === 'superficie' ? 'm' : 'ud'} `;
        mensaje += `(${m.unidades} unidad${m.unidades > 1 ? 'es' : ''})\n`;
      });
    }
  });

  mensaje += `\n游눯 *Total: $${formatearMoneda(total)}*\n`;
  mensaje += '\n_Linda Herrer칤a_';

  return mensaje;
}

function mostrarMateriales(agrupados) {
  listaMateriales.innerHTML = '';
  let total = 0;

  console.log('Materiales agrupados recibidos:', agrupados);

  const ordenCategorias = [
    'ca침o estructural cuadrado',
    'ca침o estructural redondo',
    'hierro cuadrado',
    'hierro redondo',
    'planchuela',
    'angulo',
    'laminas',
    'herrajes'
  ];

  console.log('Categor칤as a mostrar:', ordenCategorias);

  ordenCategorias.forEach(cat => {
    console.log('Procesando categor칤a:', cat);
    console.log('Materiales en esta categor칤a:', agrupados[cat]);
    
    if (agrupados[cat]) {
      listaMateriales.innerHTML += `<h3 style="color: #f39c12; margin-top: 1rem;">${cat.charAt(0).toUpperCase() + cat.slice(1)}</h3>`;
      const materialesCat = agrupados[cat].sort((a, b) => a.precio - b.precio);

      materialesCat.forEach(m => {
        console.log('Agregando material a la lista:', m);
        listaMateriales.innerHTML += `
          <div class="item-presupuesto">
            <strong>${m.nombre}</strong> <small style="color: #95a5a6;">(ID: ${m.id})</small><br>
            ${m.unidades} unidad${m.unidades > 1 ? 'es' : ''} (${m.metrosNecesarios.toFixed(2)} ${m.unidad === 'metro' ? 'mt' : m.unidad === 'superficie' ? 'm' : 'ud'})<br>
            Precio unitario: $${formatearMoneda(m.precio)}<br>
            Subtotal: <strong>$${formatearMoneda(m.subtotal)}</strong>
          </div>
        `;
        total += m.subtotal;
      });
    }
  });

  console.log('Total calculado:', total);
  totalMateriales.textContent = formatearMoneda(total);
  resultado.classList.remove('hidden');

  // Configurar el bot칩n de compartir
  document.getElementById('btn-compartir-lista').onclick = () => {
    const mensaje = generarMensajeWhatsApp(agrupados, total);
    const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
    window.open(url, '_blank');
  };
}

// Bot칩n de orden de presupuestos
toggleOrdenBtn.addEventListener('click', () => {
  listaOrden.classList.toggle('hidden');
});

listaOrden.querySelectorAll('input[name="orden"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    ordenSeleccionado = e.target.value;
    toggleOrdenBtn.textContent = `Ordenar: ${e.target.nextSibling.textContent.trim()}`;
    renderPresupuestos();
    listaOrden.classList.add('hidden');
  });
});

// Funci칩n para identificar presupuestos antiguos
function identificarPresupuestosAntiguos() {
  const presupuestosAntiguos = presupuestos.filter(p => {
    // Un presupuesto es antiguo si tiene al menos un item sin ID
    return p.items.some(item => !item.id);
  });

  const contenedorAntiguos = document.getElementById('presupuestos-antiguos');
  const listaAntiguos = document.getElementById('lista-antiguos');

  if (presupuestosAntiguos.length === 0) {
    alert('No se encontraron presupuestos con formato antiguo! 游녨');
    contenedorAntiguos.classList.add('hidden');
    return;
  }

  listaAntiguos.innerHTML = presupuestosAntiguos.map(p => `
    <li class="item-presupuesto">
      <strong>${p.nombre}</strong> (${p.fecha})<br>
      <small style="color: #95a5a6;">ID: ${p.id}</small><br>
      <small style="color: #e74c3c;">
        Materiales sin ID: ${p.items.filter(item => !item.id).length} de ${p.items.length}
      </small>
    </li>
  `).join('');

  contenedorAntiguos.classList.remove('hidden');
}

// Funci칩n para eliminar presupuestos antiguos
async function eliminarPresupuestosAntiguos() {
  const presupuestosAntiguos = presupuestos.filter(p => 
    p.items.some(item => !item.id)
  );

  if (!confirm(`쮼st치s seguro que quer칠s eliminar ${presupuestosAntiguos.length} presupuestos antiguos? Esta acci칩n no se puede deshacer.`)) {
    return;
  }

  let eliminados = 0;
  for (const p of presupuestosAntiguos) {
    try {
      await deleteDoc(doc(db, 'presupuestos', p.id));
      eliminados++;
    } catch (error) {
      console.error(`Error al eliminar presupuesto ${p.id}:`, error);
    }
  }

  alert(`Se eliminaron ${eliminados} presupuestos antiguos exitosamente.`);
  await cargarDatos(); // Recargar la lista
  document.getElementById('presupuestos-antiguos').classList.add('hidden');
}

// Event listeners para los nuevos botones
document.getElementById('btn-identificar-antiguos').addEventListener('click', identificarPresupuestosAntiguos);
document.getElementById('btn-eliminar-antiguos').addEventListener('click', eliminarPresupuestosAntiguos);

await cargarDatos();
</script>

</body>
</html>

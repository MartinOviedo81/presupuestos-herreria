<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lista de Materiales - Linda Herrer√≠a</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="lindaherreriaMC2.png" />
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="modo-oscuro">

<h2>Lista de Materiales</h2>

<!-- Bot√≥n de ordenamiento -->
<div id="menu-orden" class="trabajos-menu-custom">
  <button id="toggle-orden" class="boton-gris">Ordenar presupuestos</button>
  <div class="trabajos-lista hidden">
    <label><input type="radio" name="orden" value="nombre-asc" checked> Nombre A-Z</label>
    <label><input type="radio" name="orden" value="nombre-desc"> Nombre Z-A</label>
    <label><input type="radio" name="orden" value="fecha-asc"> Fecha ascendente</label>
    <label><input type="radio" name="orden" value="fecha-desc"> Fecha descendente</label>
  </div>
</div>

<div id="contenedor-presupuestos">
  <h3>Seleccion√° los presupuestos</h3>
  <ul id="lista-presupuestos"></ul>
  <button id="btn-confirmar" class="boton-celeste">Confirmar selecci√≥n</button>
</div>

<div id="contenedor-cantidades" class="hidden">
  <h3>Cantidades de presupuestos seleccionados</h3>
  <ul id="lista-cantidades"></ul>
  <button id="btn-generar" class="boton-verde">Generar lista de materiales</button>
</div>

<div id="resultado" class="hidden">
  <h3>Materiales necesarios</h3>
  <div id="lista-materiales"></div>
  <h3>Total: $<span id="total-materiales">0</span></h3>
</div>

<script type="module">
import { db } from './firebase-config.js';
import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const listaPresupuestos = document.getElementById('lista-presupuestos');
const btnConfirmar = document.getElementById('btn-confirmar');
const contenedorCantidades = document.getElementById('contenedor-cantidades');
const listaCantidades = document.getElementById('lista-cantidades');
const btnGenerar = document.getElementById('btn-generar');
const listaMateriales = document.getElementById('lista-materiales');
const resultado = document.getElementById('resultado');
const totalMateriales = document.getElementById('total-materiales');
const toggleOrdenBtn = document.getElementById('toggle-orden');
const listaOrden = document.querySelector('#menu-orden .trabajos-lista');

let presupuestos = [];
let materiales = [];
let ordenSeleccionado = 'nombre-asc';
let seleccionadosConCantidad = [];

async function cargarDatos() {
  const snapPresupuestos = await getDocs(collection(db, 'presupuestos'));
  const snapMateriales = await getDocs(collection(db, 'materiales'));

  presupuestos = snapPresupuestos.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  materiales = snapMateriales.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  renderPresupuestos();
}

function formatearMoneda(valor) {
  return Math.round(valor).toLocaleString('es-AR');
}

function renderPresupuestos() {
  let lista = [...presupuestos];

  lista.sort((a, b) => {
    if (ordenSeleccionado === 'nombre-asc') return a.nombre.localeCompare(b.nombre);
    if (ordenSeleccionado === 'nombre-desc') return b.nombre.localeCompare(a.nombre);
    if (ordenSeleccionado === 'fecha-asc') return new Date(a.fechaOrden) - new Date(b.fechaOrden);
    if (ordenSeleccionado === 'fecha-desc') return new Date(b.fechaOrden) - new Date(a.fechaOrden);
    return 0;
  });

  listaPresupuestos.innerHTML = lista.map(p => `
    <li>
      <label>
        <input type="checkbox" value="${p.id}">
        ${p.nombre} (${p.fecha})
      </label>
    </li>
  `).join('');
}

btnConfirmar.addEventListener('click', () => {
  const seleccionados = Array.from(listaPresupuestos.querySelectorAll('input:checked')).map(input => input.value);
  if (seleccionados.length === 0) {
    alert('Seleccion√° al menos un presupuesto.');
    return;
  }
// üí• Agregar escuchador de eventos para botones mini
listaCantidades.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;

  const id = btn.dataset.id;
  const input = listaCantidades.querySelector(`input[data-id="${id}"]`);
  if (!input) return;

  if (btn.classList.contains('boton-aumentar')) {
    input.value = parseInt(input.value) + 1;
  } else if (btn.classList.contains('boton-disminuir')) {
    if (parseInt(input.value) > 1) {
      input.value = parseInt(input.value) - 1;
    }
  } else if (btn.classList.contains('boton-eliminar')) {
    if (confirm('¬øSeguro que quer√©s eliminar este presupuesto de la selecci√≥n?')) {
      btn.closest('li').remove();
    }
  }
});
  
  listaCantidades.innerHTML = seleccionados.map(id => {
    const presupuesto = presupuestos.find(p => p.id === id);
    return `
      <li class="item-presupuesto mini-controls" data-id="${id}">
        <strong>${presupuesto.nombre}</strong> (${presupuesto.fecha})<br>
        <div class="cantidad-controles">
          <button class="btn-mini boton-disminuir" data-id="${id}"><i data-lucide="square-minus"></i></button>
          <input type="number" min="1" value="1" class="input-cantidad" data-id="${id}">
          <button class="btn-mini boton-aumentar" data-id="${id}"><i data-lucide="square-plus"></i></button>
          <button class="btn-mini boton-eliminar" data-id="${id}"><i data-lucide="trash-2"></i></button>
        </div>
      </li>
    `;
  }).join('');
lucide.createIcons();
  contenedorCantidades.classList.remove('hidden');
  lucide.createIcons(); // <- esto es MUY importante para que se dibujen los √≠conos correctamente
});

btnGenerar.addEventListener('click', () => {
  seleccionadosConCantidad = [];
  listaCantidades.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;

  const id = btn.dataset.id;
  const input = listaCantidades.querySelector(`input[data-id="${id}"]`);
  if (!input) return;

  if (btn.classList.contains('boton-aumentar')) {
    input.value = parseInt(input.value) + 1;
  } else if (btn.classList.contains('boton-disminuir')) {
    if (parseInt(input.value) > 1) {
      input.value = parseInt(input.value) - 1;
    }
  } else if (btn.classList.contains('boton-eliminar')) {
    if (confirm('¬øSeguro que quer√©s eliminar este presupuesto de la selecci√≥n?')) {
      btn.closest('li').remove();
    }
  }
});

  listaCantidades.querySelectorAll('input[type="number"]').forEach(input => {
    const id = input.dataset.id;
    const cantidad = parseInt(input.value) || 1;
    seleccionadosConCantidad.push({ id, cantidad });
  });

  generarListaMateriales();
});

function generarListaMateriales() {
  const materialesNecesarios = {};

  seleccionadosConCantidad.forEach(({ id, cantidad }) => {
    const presupuesto = presupuestos.find(p => p.id === id);
    if (!presupuesto) return;

    presupuesto.items.forEach(item => {
      if (!materialesNecesarios[item.nombre]) {
        materialesNecesarios[item.nombre] = 0;
      }
      materialesNecesarios[item.nombre] += item.cantidad * cantidad;
    });
  });

  const materialesAgrupados = {};

  for (let nombre in materialesNecesarios) {
    const mat = materiales.find(m => m.nombre === nombre);
    if (!mat) continue;

    const cantidadNecesaria = materialesNecesarios[nombre];
    const unidadesCompradas = Math.ceil(cantidadNecesaria / mat.fraccionamiento);
    const subtotal = unidadesCompradas * mat.precio;

    if (!materialesAgrupados[mat.categoria]) materialesAgrupados[mat.categoria] = [];

    materialesAgrupados[mat.categoria].push({
      nombre: mat.nombre,
      unidad: mat.unidad,
      metrosNecesarios: cantidadNecesaria,
      unidades: unidadesCompradas,
      precio: mat.precio,
      subtotal
    });
  }

  mostrarMateriales(materialesAgrupados);
}

function mostrarMateriales(agrupados) {
  listaMateriales.innerHTML = '';
  let total = 0;

  const ordenCategorias = [
    'ca√±os estructurales',
    'hierros cuadrados',
    'hierros redondos',
    'planchuelas',
    'hierros angulo',
    'laminas',
    'herrajes'
  ];

  ordenCategorias.forEach(cat => {
    if (agrupados[cat]) {
      listaMateriales.innerHTML += `<h3 style="color: #f39c12; margin-top: 1rem;">${cat.charAt(0).toUpperCase() + cat.slice(1)}</h3>`;
      const materialesCat = agrupados[cat].sort((a, b) => a.precio - b.precio);

      materialesCat.forEach(m => {
        listaMateriales.innerHTML += `
          <div class="item-presupuesto">
            <strong>${m.nombre}</strong><br>
            ${m.unidades} unidad${m.unidades > 1 ? 'es' : ''} (${m.metrosNecesarios.toFixed(2)} ${m.unidad === 'metro' ? 'mt' : m.unidad === 'superficie' ? 'm¬≤' : 'ud'})<br>
            Precio unitario: $${formatearMoneda(m.precio)}<br>
            Subtotal: <strong>$${formatearMoneda(m.subtotal)}</strong>
          </div>
        `;
        total += m.subtotal;
      });
    }
  });

  totalMateriales.textContent = formatearMoneda(total);
  resultado.classList.remove('hidden');
}

// Bot√≥n de orden de presupuestos
toggleOrdenBtn.addEventListener('click', () => {
  listaOrden.classList.toggle('hidden');
});

listaOrden.querySelectorAll('input[name="orden"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    ordenSeleccionado = e.target.value;
    toggleOrdenBtn.textContent = `Ordenar: ${e.target.nextSibling.textContent.trim()}`;
    renderPresupuestos();
    listaOrden.classList.add('hidden');
  });
});

await cargarDatos();
</script>

</body>
</html>

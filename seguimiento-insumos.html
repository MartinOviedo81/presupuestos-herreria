<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento de Insumos - Linda Herrería</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="modo-oscuro">
  <!-- Menú hamburguesa -->
  <div class="menu-hamburguesa" id="btnMenu">
    <i data-lucide="menu"></i>
  </div>

  <div class="opciones-menu hidden" id="menuOpciones">
    <a href="index.html">
      <i data-lucide="home"></i> Inicio
    </a>
  </div>

  <h2>Seguimiento de Insumos</h2>

  <nav class="tabs-bar">
    <button class="tab-button active" data-tab="gas">
      <i data-lucide="flame"></i> Gas
    </button>
    <button class="tab-button" data-tab="alambre">
      <i data-lucide="cable"></i> Alambre
    </button>
    <button class="tab-button" data-tab="historial">
      <i data-lucide="history"></i> Historial
    </button>
  </nav>

  <!-- Sección Gas -->
  <div id="seccion-gas" class="seccion-tab visible">
    <div class="estado-actual">
      <h3>Carga Actual de Gas</h3>
      <div id="estado-gas" class="estado-insumo">
        <!-- Se llenará con JavaScript -->
      </div>
    </div>

    <h3>Nueva Carga de Gas</h3>
    <form id="form-gas">
      <label>Fecha de inicio:
        <input type="date" id="gas-fecha-inicio" required>
      </label>

      <label>Kilos cargados:
        <input type="number" id="gas-kilos" step="1" min="0" value="9" required>
      </label>

      <label>Precio total:
        <input type="number" id="gas-precio" step="1" min="0" value="15000" required>
      </label>

      <button type="submit" class="boton-celeste">
        <i data-lucide="plus-circle"></i> Registrar Carga
      </button>
    </form>
  </div>

  <!-- Sección Alambre -->
  <div id="seccion-alambre" class="seccion-tab">
    <div class="estado-actual">
      <h3>Rollo de Alambre Actual</h3>
      <div id="estado-alambre" class="estado-insumo">
        <!-- Se llenará con JavaScript -->
      </div>
    </div>

    <h3>Nuevo Rollo de Alambre</h3>
    <form id="form-alambre">
      <label>Fecha de inicio:
        <input type="date" id="alambre-fecha-inicio" required>
      </label>

      <label>Precio:
        <input type="number" id="alambre-precio" step="1" min="0" required>
      </label>

      <button type="submit" class="boton-celeste">
        <i data-lucide="plus-circle"></i> Registrar Rollo
      </button>
    </form>
  </div>

  <!-- Sección Historial -->
  <div id="seccion-historial" class="seccion-tab">
    <div class="filtros-historial">
      <button class="boton-vista" data-tipo="gas">
        <i data-lucide="flame"></i> Gas
      </button>
      <button class="boton-vista" data-tipo="alambre">
        <i data-lucide="cable"></i> Alambre
      </button>
    </div>

    <div id="historial-lista"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
    import {
      getFirestore, collection, addDoc, getDocs, query, 
      orderBy, where, doc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDirRKj8_-oleUdIhDl7LUud-Y9I_T7THQ",
      authDomain: "presupuestos-herreria.firebaseapp.com",
      projectId: "presupuestos-herreria",
      appId: "1:824709991960:web:2993a2886f6aa4def3bd6d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Referencias a elementos del DOM
    const tabButtons = document.querySelectorAll('.tab-button');
    const secciones = document.querySelectorAll('.seccion-tab');
    const formGas = document.getElementById('form-gas');
    const formAlambre = document.getElementById('form-alambre');
    const estadoGas = document.getElementById('estado-gas');
    const estadoAlambre = document.getElementById('estado-alambre');
    const historialLista = document.getElementById('historial-lista');

    // Cambio de tabs
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const tab = btn.dataset.tab;
        secciones.forEach(s => s.classList.remove('visible'));
        document.getElementById(`seccion-${tab}`).classList.add('visible');

        if (tab === 'historial') {
          cargarHistorial('gas');
        }
      });
    });

    // Establecer fecha actual por defecto al cargar la página
    const fechaActual = new Date().toISOString().split('T')[0];
    document.getElementById('gas-fecha-inicio').value = fechaActual;
    document.getElementById('alambre-fecha-inicio').value = fechaActual;

    // Event Listeners para los formularios
    formGas.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const fechaInicio = new Date(document.getElementById('gas-fecha-inicio').value).toISOString();
        
        // Buscar y finalizar carga anterior
        const colGas = collection(db, 'insumos-gas');
        const snapGas = await getDocs(colGas);
        let cargaActiva = null;

        snapGas.forEach(doc => {
          const data = doc.data();
          if (data.fechaFin === null) {
            cargaActiva = doc;
          }
        });

        if (cargaActiva) {
          await updateDoc(doc(db, 'insumos-gas', cargaActiva.id), {
            fechaFin: fechaInicio
          });
        }

        const data = {
          fechaInicio,
          kilos: parseInt(document.getElementById('gas-kilos').value),
          precio: parseInt(document.getElementById('gas-precio').value),
          fechaFin: null
        };

        await addDoc(collection(db, 'insumos-gas'), data);
        
        // Restablecer valores por defecto
        document.getElementById('gas-fecha-inicio').value = new Date().toISOString().split('T')[0];
        document.getElementById('gas-kilos').value = "9";
        document.getElementById('gas-precio').value = "15000";
        
        await cargarEstadoActual();
        alert('Carga de gas registrada correctamente');
      } catch (error) {
        console.error('Error al registrar carga de gas:', error);
        alert('Error al registrar la carga de gas');
      }
    });

    formAlambre.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const fechaInicio = new Date(document.getElementById('alambre-fecha-inicio').value).toISOString();
        
        // Buscar y finalizar rollo anterior
        const colAlambre = collection(db, 'insumos-alambre');
        const snapAlambre = await getDocs(colAlambre);
        let rolloActivo = null;

        snapAlambre.forEach(doc => {
          const data = doc.data();
          if (data.fechaFin === null) {
            rolloActivo = doc;
          }
        });

        if (rolloActivo) {
          await updateDoc(doc(db, 'insumos-alambre', rolloActivo.id), {
            fechaFin: fechaInicio
          });
        }

        const data = {
          fechaInicio,
          precio: parseInt(document.getElementById('alambre-precio').value),
          fechaFin: null
        };

        await addDoc(collection(db, 'insumos-alambre'), data);
        
        // Restablecer fecha por defecto
        document.getElementById('alambre-fecha-inicio').value = new Date().toISOString().split('T')[0];
        document.getElementById('alambre-precio').value = "";
        
        await cargarEstadoActual();
        alert('Rollo de alambre registrado correctamente');
      } catch (error) {
        console.error('Error al registrar rollo de alambre:', error);
        alert('Error al registrar el rollo de alambre');
      }
    });

    // Cargar estado actual
    async function cargarEstadoActual() {
      try {
        // Cargar último gas
        const colGas = collection(db, 'insumos-gas');
        const snapGas = await getDocs(colGas);
        let ultimoGas = null;
        let ultimaFechaGas = null;

        snapGas.forEach(doc => {
          const data = doc.data();
          const fecha = new Date(data.fechaInicio);
          if (data.fechaFin === null && (!ultimaFechaGas || fecha > ultimaFechaGas)) {
            ultimoGas = { id: doc.id, ...data };
            ultimaFechaGas = fecha;
          }
        });

        if (ultimoGas) {
          const duracion = calcularDuracion(ultimoGas.fechaInicio);
          estadoGas.innerHTML = `
            <div class="info-estado">
              <p><strong>Inicio:</strong> ${new Date(ultimoGas.fechaInicio).toLocaleDateString()}</p>
              <p><strong>Kilos:</strong> ${ultimoGas.kilos} kg</p>
              <p><strong>Precio:</strong> ${formatearMoneda(ultimoGas.precio)}</p>
              <p><strong>Tiempo en uso:</strong> ${duracion} días</p>
            </div>
            <div class="botones-accion">
              <button class="boton-rojo" onclick="finalizarGas('${ultimoGas.id}')">
                <i data-lucide="x-circle"></i> Finalizar
              </button>
              <button class="boton-rojo" onclick="eliminarInsumo('${ultimoGas.id}', 'gas')">
                <i data-lucide="trash-2"></i> Eliminar
              </button>
            </div>
          `;
        } else {
          estadoGas.innerHTML = '<p>No hay carga de gas activa</p>';
        }

        // Cargar último alambre
        const colAlambre = collection(db, 'insumos-alambre');
        const snapAlambre = await getDocs(colAlambre);
        let ultimoAlambre = null;
        let ultimaFechaAlambre = null;

        snapAlambre.forEach(doc => {
          const data = doc.data();
          const fecha = new Date(data.fechaInicio);
          if (data.fechaFin === null && (!ultimaFechaAlambre || fecha > ultimaFechaAlambre)) {
            ultimoAlambre = { id: doc.id, ...data };
            ultimaFechaAlambre = fecha;
          }
        });

        if (ultimoAlambre) {
          const duracion = calcularDuracion(ultimoAlambre.fechaInicio);
          estadoAlambre.innerHTML = `
            <div class="info-estado">
              <p><strong>Inicio:</strong> ${new Date(ultimoAlambre.fechaInicio).toLocaleDateString()}</p>
              <p><strong>Precio:</strong> ${formatearMoneda(ultimoAlambre.precio)}</p>
              <p><strong>Tiempo en uso:</strong> ${duracion} días</p>
            </div>
            <div class="botones-accion">
              <button class="boton-rojo" onclick="finalizarAlambre('${ultimoAlambre.id}')">
                <i data-lucide="x-circle"></i> Finalizar
              </button>
              <button class="boton-rojo" onclick="eliminarInsumo('${ultimoAlambre.id}', 'alambre')">
                <i data-lucide="trash-2"></i> Eliminar
              </button>
            </div>
          `;
        } else {
          estadoAlambre.innerHTML = '<p>No hay rollo de alambre activo</p>';
        }

        lucide.createIcons();
      } catch (error) {
        console.error('Error al cargar estado actual:', error);
      }
    }

    // Función para calcular duración
    function calcularDuracion(fechaInicio, fechaFin = null) {
      const inicio = new Date(fechaInicio);
      const fin = fechaFin ? new Date(fechaFin) : new Date();
      const diferencia = fin - inicio;
      const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
      return dias;
    }

    // Función para formatear moneda
    function formatearMoneda(valor) {
      return new Intl.NumberFormat('es-AR', {
        style: 'currency',
        currency: 'ARS',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(valor);
    }

    // Cargar historial
    async function cargarHistorial(tipo) {
      const collection_name = `insumos-${tipo}`;
      const snap = await getDocs(collection(db, collection_name));
      
      historialLista.innerHTML = `<h3>${tipo === 'gas' ? 'Historial de Gas' : 'Historial de Alambre'}</h3>`;
      
      // Convertir a array para poder ordenar
      const items = [];
      snap.forEach(doc => {
        items.push({ id: doc.id, ...doc.data() });
      });

      // Ordenar por fecha de inicio (más reciente primero)
      items.sort((a, b) => new Date(b.fechaInicio) - new Date(a.fechaInicio));
      
      items.forEach(data => {
        const duracion = calcularDuracion(data.fechaInicio, data.fechaFin);
        
        const elemento = document.createElement('div');
        elemento.className = 'item-presupuesto';
        elemento.innerHTML = `
          <div class="item-contenido">
            <strong>${new Date(data.fechaInicio).toLocaleDateString()}</strong>
            ${data.fechaFin ? ` - ${new Date(data.fechaFin).toLocaleDateString()}` : ' (Activo)'}
            <br>
            ${tipo === 'gas' ? `Kilos: ${data.kilos} kg<br>` : ''}
            Precio: ${formatearMoneda(data.precio)}<br>
            Duración: ${duracion} días
          </div>
          <div class="item-acciones">
            <button class="boton-rojo" onclick="eliminarInsumo('${data.id}', '${tipo}')">
              <i data-lucide="trash-2"></i>
            </button>
          </div>
        `;
        historialLista.appendChild(elemento);
      });

      lucide.createIcons();
    }

    // Finalizar insumos
    window.finalizarGas = async (id) => {
      if (confirm('¿Confirmar finalización de la carga de gas?')) {
        await updateDoc(doc(db, 'insumos-gas', id), {
          fechaFin: new Date().toISOString()
        });
        await cargarEstadoActual();
        cargarHistorial('gas');
      }
    };

    window.finalizarAlambre = async (id) => {
      if (confirm('¿Confirmar finalización del rollo de alambre?')) {
        await updateDoc(doc(db, 'insumos-alambre', id), {
          fechaFin: new Date().toISOString()
        });
        await cargarEstadoActual();
        cargarHistorial('alambre');
      }
    };

    // Filtros de historial
    document.querySelectorAll('.filtros-historial .boton-vista').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filtros-historial .boton-vista').forEach(b => 
          b.classList.remove('activo')
        );
        btn.classList.add('activo');
        cargarHistorial(btn.dataset.tipo);
      });
    });

    // Menú hamburguesa
    const btnMenu = document.getElementById('btnMenu');
    const menuOpciones = document.getElementById('menuOpciones');

    btnMenu.addEventListener('click', () => {
      menuOpciones.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!btnMenu.contains(e.target) && !menuOpciones.contains(e.target)) {
        menuOpciones.classList.add('hidden');
      }
    });

    // Función para eliminar insumo
    window.eliminarInsumo = async (id, tipo) => {
      const mensaje = tipo === 'gas' ? 
        '¿Estás seguro que querés eliminar esta carga de gas?' : 
        '¿Estás seguro que querés eliminar este rollo de alambre?';
      
      if (confirm(mensaje)) {
        try {
          await deleteDoc(doc(db, `insumos-${tipo}`, id));
          await cargarEstadoActual();
          cargarHistorial(tipo);
          alert('Registro eliminado correctamente');
        } catch (error) {
          console.error('Error al eliminar:', error);
          alert('Error al eliminar el registro');
        }
      }
    };

    // Inicialización
    cargarEstadoActual();
    lucide.createIcons();
  </script>
</body>
</html> 
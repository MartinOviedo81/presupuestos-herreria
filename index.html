<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Linda Herrer√≠a - Presupuestos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="lindaherreriaColor.png" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="modo-oscuro">
  <h2>Linda Herrer√≠a</h2>

 <!-- Men√∫ Hamburguesa -->
 
<div class="menu-hamburguesa" onclick="toggleMenu()">‚â°</div>

<div class="opciones-menu hidden" id="menuOpciones">
  <a href="cargar-materiales.html">
    <i data-lucide="pencil-line"></i> Cargar nuevo material
  </a>
  <a href="config-tareas.html">
    <i data-lucide="anvil"></i> Configurar tareas
  </a>
  <a href="lista-materiales.html">
  <i data-lucide="shopping-cart"></i> Lista de materiales
</a>
  <a href="lista-pedidos.html">
  <i data-lucide="file-text"></i> Gestion de pedidos
</a>
  <a href="galeria.html">
  <i data-lucide="image"></i> Galer√≠a de im√°genes
</a>
</div>
 
<div id="menu-categorias" class="trabajos-menu-custom">
 <button id="toggle-categorias" class="boton-gris">
  <i data-lucide="paperclip"></i> Categor√≠as
</button>
  <div class="trabajos-lista hidden">
    <label><input type="radio" name="cat" value="todas" checked> Todas las categor√≠as</label>
    <label><input type="radio" name="cat" value="ca√±o estructural cuadrado"> Ca√±os estructurales cuadrados</label>
    <label><input type="radio" name="cat" value="ca√±o estructural redondo"> Ca√±os estructurales redondos</label>
    <label><input type="radio" name="cat" value="hierro cuadrado"> Hierros cuadrados</label>
    <label><input type="radio" name="cat" value="hierro redondo"> Hierros redondos</label>
    <label><input type="radio" name="cat" value="planchuela"> Planchuelas</label>
    <label><input type="radio" name="cat" value="angulo"> Angulo</label>
    <label><input type="radio" name="cat" value="laminas"> L√°minas</label>
    <label><input type="radio" name="cat" value="herrajes"> Herrajes</label>
  </div>
</div>
  <div id="carrusel-materiales" class="carrusel"></div>
  <div id="material-seleccionado"></div>

  <hr />
 <!-- <h2>Presupuesto Actual</h2> -->
<div id="nombre-wrapper" style="display: flex; align-items: center; gap: 8px;">
  <input type="text" id="nombre-presupuesto" placeholder="Nombre presupuesto" />
</div>
  <button id="guardar-presupuesto" class="boton-naranja">
  <i data-lucide="save"></i> Guardar presupuesto
</button>

  <ul id="presupuesto"></ul>
  <p><strong>Total estimado: $<span id="total">0</span></strong></p>
<div id="menu-orden" class="trabajos-menu-custom">
  <button id="toggle-orden" class="boton-gris">Ordenar por</button>
  <div class="trabajos-lista hidden">
    <label><input type="radio" name="orden" value="fecha-desc" checked> Fecha ‚Üì</label>
    <label><input type="radio" name="orden" value="fecha-asc"> Fecha ‚Üë</label>
    <label><input type="radio" name="orden" value="nombre-asc"> Nombre A-Z</label>
    <label><input type="radio" name="orden" value="nombre-desc"> Nombre Z-A</label>
    <label><input type="radio" name="orden" value="total-desc"> Total ‚Üì</label>
    <label><input type="radio" name="orden" value="total-asc"> Total ‚Üë</label>
  </div>
</div>
  <div id="presupuestos-guardados"></div>
  
  <!-- Modal para ver im√°genes -->
  <div id="imagen-modal" class="modal">
    <span class="cerrar-modal">&times;</span>
    <img class="modal-contenido" id="img-ampliada">
  </div>

  <!-- Modal para ayuda de expresiones -->
  <div id="ayuda-modal" class="modal">
    <div class="modal-ayuda-contenido">
      <span class="cerrar-modal" onclick="cerrarAyudaExpresiones()">&times;</span>
      <h3>üìù Gu√≠a de Expresiones</h3>
      <div class="ejemplos-grid">
        <div class="ejemplo">
          <h4>Medidas Simples</h4>
          <code>3.50</code>
          <p>‚ö†Ô∏è Usa siempre punto (.) para decimales, no coma</p>
        </div>
        <div class="ejemplo">
          <h4>Multiplicaciones</h4>
          <code>2 x 3</code> o <code>2.5 x 1.5</code>
          <p>Multiplica dos medidas (usa punto para decimales)</p>
        </div>
        <div class="ejemplo">
          <h4>Circunferencias</h4>
          <code>c 0.30</code> o <code>c0.30</code>
          <p>Calcula el per√≠metro completo (œÄ √ó di√°metro)</p>
        </div>
        <div class="ejemplo">
          <h4>Arcos (Medio C√≠rculo)</h4>
          <code>a 0.30</code> o <code>a0.30</code>
          <p>Calcula medio per√≠metro (œÄ √ó di√°metro √∑ 2)</p>
        </div>
        <div class="ejemplo">
          <h4>Con +20cm Extra</h4>
          <code>c 0.30+</code> o <code>a0.30+</code>
          <p>Agrega 20cm al per√≠metro o arco</p>
        </div>
        <div class="ejemplo">
          <h4>M√∫ltiples Medidas</h4>
          <code>3.50, c0.30, a0.30</code>
          <p>Separa medidas con comas</p>
        </div>
        <div class="ejemplo">
          <h4>Multiplicar Per√≠metros</h4>
          <code>(c0.30) x 2</code> o <code>(a0.30+) x 2</code>
          <p>Multiplica una circunferencia o arco</p>
        </div>
      </div>
      <div class="alerta-decimal">
        ‚ö†Ô∏è IMPORTANTE: Siempre usa punto (.) para decimales, nunca coma (,)
      </div>
    </div>
  </div>

<script src="https://unpkg.com/lucide@latest"></script>
  <script type="module">
    lucide.createIcons();
    import { db } from './firebase-config.js';
    import {
      collection, getDocs, addDoc, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    let trabajos = {};
    let materiales = [];
    let presupuesto = [];
    let presupuestoIdActual = null;

    
    const carrusel = document.getElementById('carrusel-materiales');
    const contenedorSeleccion = document.getElementById('material-seleccionado');
    const presupuestoUl = document.getElementById('presupuesto');
    const totalSpan = document.getElementById('total');
    const nombrePresupuesto = document.getElementById('nombre-presupuesto');
    const btnGuardar = document.getElementById('guardar-presupuesto');

   
let categoriaSeleccionada = 'todas';
const toggleCategoriasBtn = document.getElementById('toggle-categorias');
const listaCategorias = document.querySelector('#menu-categorias .trabajos-lista');

toggleCategoriasBtn.addEventListener('click', () => {
  listaCategorias.classList.toggle('hidden');
});

document.querySelectorAll('input[name="cat"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    categoriaSeleccionada = e.target.value;

    let icono = 'paperclip'; // icono por defecto

    switch (categoriaSeleccionada) {
      case 'ca√±os estructurales':
        icono = 'square-square'; // ca√±o cuadrado
        break;
      case 'ca√±os estructurales redondos':
        icono = 'circle'; // ca√±o redondo
        break;
      case 'hierros cuadrados':
        icono = 'box'; // barras
        break;
      case 'hierros redondos':
        icono = 'blend'; // redondo
        break;
      case 'planchuelas':
        icono = 'stretch-horizontal'; // chapas
        break;
      case 'hierros angulo':
        icono = 'triangle'; // √°ngulo
        break;
      case 'laminas':
        icono = 'layers'; // laminas
        break;
      case 'herrajes':
        icono = 'key-round'; // herramientas
        break;
      case 'todas':
        icono = 'paperclip'; // lista general
        break;
    }

    toggleCategoriasBtn.innerHTML = `<i data-lucide="${icono}"></i> ${categoriaSeleccionada.charAt(0).toUpperCase() + categoriaSeleccionada.slice(1)}`;

    lucide.createIcons(); // üî• ¬°recrear iconos cada vez que cambia!

    aplicarFiltros();
    listaCategorias.classList.add('hidden');
  });
});
    async function cargarMateriales() {
      const snap = await getDocs(collection(db, 'materiales'));
      materiales = [];
      snap.forEach(doc => materiales.push({ id: doc.id, ...doc.data() }));
     aplicarFiltros();
    }
function aplicarFiltros() {
 const categoria = categoriaSeleccionada;
  let filtrados = materiales;

  if (categoria !== 'todas') {
    filtrados = filtrados.filter(m => (m.categoria || '').toLowerCase() === categoria);
  }

  renderCarrusel(filtrados);
}
    async function cargarTareas() {
      const snap = await getDocs(collection(db, 'tareas'));
      trabajos = {};
      snap.forEach(doc => {
        const data = doc.data();
        trabajos[data.nombre] = data.multiplicador;
      });
    }

    function renderCarrusel(lista) {
      carrusel.innerHTML = '';
      lista.forEach((mat) => {
        const tarjeta = document.createElement('div');
        tarjeta.className = 'tarjeta';
       const precioUnidad = mat.precio / mat.fraccionamiento;
tarjeta.innerHTML = `
  <strong>${mat.nombre}</strong>
  <p>
    $${formatearMoneda(mat.precio)} ‚Üí 
    $${formatearMoneda(precioUnidad)} x ${
      mat.unidad === 'metro' ? 'mt' : mat.unidad === 'superficie' ? 'm¬≤' : 'ud'
    }
  </p>
`;
        tarjeta.addEventListener('click', () => renderSeleccion(mat));
        carrusel.appendChild(tarjeta);
      });
    }

    function calcularTotalDesdeTexto(texto) {
      // Primero separamos todas las expresiones por coma
      const expresiones = texto.toLowerCase().split(/,|y/i).map(exp => exp.trim());
      let total = 0;

      for (let expresion of expresiones) {
        // Si es solo un n√∫mero (permite decimales con punto)
        if (/^\d+(\.\d+)?$/.test(expresion)) {
          total += parseFloat(expresion);
        }
        // Si es una expresi√≥n con par√©ntesis que contiene una circunferencia o arco
        else if (expresion.match(/\(\s*[ca]\s*\d+(?:\.\d+)?(?:\+)?\s*\)\s*(?:x|de)?\s*\d+(?:\.\d+)?/i)) {
          const match = expresion.match(/\(\s*([ca])\s*(\d+(?:\.\d+)?)(\+)?\s*\)\s*(?:x|de)?\s*(\d+(?:\.\d+)?)/i);
          if (match) {
            const tipo = match[1];
            const diametro = parseFloat(match[2]);
            const tieneExtra = match[3] === '+';
            const multiplicador = parseFloat(match[4]);
            const circunferencia = Math.PI * diametro;
            // Si es arco, dividir por 2
            const medida = tipo === 'a' ? circunferencia / 2 : circunferencia;
            // Si tiene el +, sumamos 0.20 antes de multiplicar
            const subtotal = tieneExtra ? medida + 0.20 : medida;
            total += subtotal * multiplicador;
          }
        }
        // Si es una expresi√≥n de circunferencia o arco simple (ahora acepta sin espacios)
        else if (/^[ca]\s*\d/.test(expresion)) {
          // Extraemos el tipo (c o a), el di√°metro y verificamos si hay un '+'
          const match = expresion.match(/^([ca])\s*(\d+(?:\.\d+)?)(\+)?/);
          if (match) {
            const tipo = match[1];
            const diametro = parseFloat(match[2]);
            const tieneExtra = match[3] === '+';
            // Calculamos la circunferencia (œÄ √ó di√°metro)
            const circunferencia = Math.PI * diametro;
            // Si es arco, dividir por 2
            const medida = tipo === 'a' ? circunferencia / 2 : circunferencia;
            // Si hay un '+', sumamos 0.20
            total += tieneExtra ? medida + 0.20 : medida;
          }
        } else if (expresion.includes('(')) {
          // Manejo de expresiones con par√©ntesis normales
          const match = expresion.match(/\((.*?)\)\s*(?:x|de)?\s*(\d+(?:\.\d+)?)?/i);
          if (match) {
            const expresionInterna = match[1];
            const multiplicadorExterno = match[2] ? parseFloat(match[2]) : 1;
            const resultadoInterno = calcularExpresionSimple(expresionInterna);
            total += resultadoInterno * multiplicadorExterno;
          }
        } else {
          // Para expresiones simples sin par√©ntesis
          total += calcularExpresionSimple(expresion);
        }
      }
      
      return total;
    }

    function calcularExpresionSimple(expresion) {
      const match = expresion.match(/(\d+(?:\.\d+)?)\s*(?:x|de)?\s*(\d+(?:\.\d+)?)/i);
      if (match) {
        const num1 = parseFloat(match[1]);
        const num2 = parseFloat(match[2]);
        return num1 * num2;
      }
      return 0;
    }
function formatearMoneda(valor) {
  return Math.round(valor).toLocaleString('es-AR', {
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  });
}

function redondearADecena(valor) {
  return Math.round(valor / 100) * 100;
}
    
function renderSeleccion(mat) {
  contenedorSeleccion.innerHTML = '';

  const precioPorUnidad = mat.precio / mat.fraccionamiento;

  const trabajosActivosPorDefecto = ['Corte y soldadura', 'Pintura', 'Venta y embalado'];

  const trabajosInputs = Object.entries(trabajos).map(([nombre, mult]) => {
    const checked = trabajosActivosPorDefecto.includes(nombre) ? 'checked' : '';
    return `
      <label>
        <input type="checkbox" class="check-trabajo" data-nombre="${nombre}" ${checked}>
        ${nombre} √ó ${mult}
      </label>
    `;
  }).join('<br>');

  const html = `
    <div class="tarjeta-expandida">
      <h3>${mat.nombre}</h3>
      <p class="detalle-precio-expandido">
        <strong>$${formatearMoneda(mat.precio)}</strong> ‚Üí 
        $${formatearMoneda(precioPorUnidad)} x ${
          mat.unidad === 'metro' ? 'mt' : mat.unidad === 'superficie' ? 'm¬≤' : 'u'
        }
      </p>
      <div class="input-ayuda-container">
        <input type="text" id="input-detalle" placeholder="Uso: 1 x 2, 2 x 1.5..." />
        <button class="boton-ayuda" onclick="mostrarAyudaExpresiones()">
          <i data-lucide="help-circle"></i>
        </button>
      </div>
      <div class="trabajos-contenedor">
        <div id="trabajos-menu" class="trabajos-menu-custom">
          <button id="toggle-trabajos" class="boton-gris">
            <i data-lucide="calculator"></i> Multiplicador
          </button>
          <div class="trabajos-lista hidden">${trabajosInputs}</div>
        </div>
        <span id="multiplicador-acumulado" class="label-multiplicador">√ó 0</span>
      </div>
      <button class="boton-verde" id="btn-agregar">Agregar</button>
    </div>
  `;

  contenedorSeleccion.innerHTML = html;
lucide.createIcons();
  setTimeout(() => {
    const labelMultiplicador = document.getElementById('multiplicador-acumulado');
    const checkboxes = contenedorSeleccion.querySelectorAll('.check-trabajo');
    const toggleBtn = document.getElementById('toggle-trabajos');
    const trabajosLista = contenedorSeleccion.querySelector('.trabajos-lista');

    toggleBtn.addEventListener('click', () => {
      trabajosLista.classList.toggle('hidden');
    });

    document.getElementById('input-detalle').addEventListener('focus', () => {
      trabajosLista.classList.add('hidden');
    });

    checkboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', () => {
        let total = 0;
        checkboxes.forEach((check) => {
          if (check.checked) {
            const nombre = check.dataset.nombre;
            total += trabajos[nombre];
          }
        });
        labelMultiplicador.textContent = `√ó ${total.toFixed(2)}`;
      });
    });

    // ‚úÖ Calcular total inicial con los prechequeados
    let totalInicial = 0;
    checkboxes.forEach((check) => {
      if (check.checked) {
        const nombre = check.dataset.nombre;
        totalInicial += trabajos[nombre];
      }
    });
    labelMultiplicador.textContent = `√ó ${totalInicial.toFixed(2)}`;

    document.getElementById('btn-agregar').addEventListener('click', () => {
      const texto = document.getElementById('input-detalle').value.trim();
      if (!texto) return alert("Ingres√° el detalle de uso.");
      const cantidad = calcularTotalDesdeTexto(texto);
      if (!cantidad || isNaN(cantidad)) return alert("No se pudo interpretar la cantidad.");

      let multiplicadorTotal = 0;
      let trabajosSeleccionados = [];

      checkboxes.forEach((check) => {
        if (check.checked) {
          const nombre = check.dataset.nombre;
          const mult = trabajos[nombre];
          multiplicadorTotal += mult;
          trabajosSeleccionados.push(`${nombre} √ó${mult}`);
        }
      });

      if (multiplicadorTotal === 0) return alert("Seleccion√° al menos un trabajo.");

      const subtotal = precioPorUnidad * cantidad * multiplicadorTotal;

      presupuesto.push({
        id: mat.id,
        nombre: mat.nombre,
        unidad: mat.unidad,
        cantidad,
        precioPorUnidad,
        trabajos: trabajosSeleccionados,
        multiplicadorTotal,
        subtotal
      });

      renderPresupuesto();

      contenedorSeleccion.classList.add('fade-out');
      setTimeout(() => {
        contenedorSeleccion.innerHTML = '';
        contenedorSeleccion.classList.remove('fade-out');
      }, 700);
    });
  }, 0);
}

    function renderPresupuesto() {
      presupuestoUl.innerHTML = '';
      let total = 0;

      presupuesto.forEach((item, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
  <div>
    <span style="color: #f39c12; font-weight: bold;">${item.nombre}</span>,
    ${item.cantidad.toFixed(2)} ${item.unidad === 'metro' ? 'mt' : item.unidad === 'superficie' ? 'm¬≤' : 'ud.'},
    <span style="color: #ccc;">$${formatearMoneda(item.precioPorUnidad)} x <strong>${item.multiplicadorTotal.toFixed(2)}</strong></span>,
    <span style="color: #ccc;">Subtotal: <strong>$${formatearMoneda(item.subtotal)}</strong></span>
  </div>
  <button class="boton-rojo" onclick="eliminarItem(${i})">Eliminar</button>
`;
        presupuestoUl.appendChild(li);
        total += item.subtotal;
      });

     const totalRedondeado = redondearADecena(total);
totalSpan.textContent = formatearMoneda(totalRedondeado);
    }

    window.eliminarItem = (i) => {
      presupuesto.splice(i, 1);
      renderPresupuesto();
    };
async function actualizarPreciosEnPresupuesto() {
  const snap = await getDocs(collection(db, 'materiales'));
  const preciosActuales = {};
  snap.forEach(doc => {
    const m = doc.data();
    preciosActuales[m.nombre] = m.precio / m.fraccionamiento;
  });

  presupuesto = presupuesto.map(item => {
    const nuevoPrecio = preciosActuales[item.nombre] || item.precioPorUnidad;
    const nuevoSubtotal = nuevoPrecio * item.cantidad * item.multiplicadorTotal;
    return {
      ...item,
      precioPorUnidad: nuevoPrecio,
      subtotal: nuevoSubtotal
    };
  });
}
    btnGuardar.addEventListener('click', async () => {
  const nombre = nombrePresupuesto.value.trim(); // ‚úÖ ahora est√° definida correctamente
  if (!nombre) return alert('Pon√© un nombre al presupuesto.');
 if (presupuestoIdActual) {
    await actualizarPreciosEnPresupuesto();
  }
  const fechaActual = new Date();
  const fecha = fechaActual.toLocaleDateString('es-AR');
  const fechaOrden = fechaActual.toISOString();
  const totalTexto = totalSpan.textContent;
const totalNum = parseFloat(totalTexto.replace(/\./g, '').replace(',', '.'));
const totalRedondeado = redondearADecena(totalNum);

const data = {
  nombre,
  fecha,
  fechaOrden,
  total: totalRedondeado.toFixed(0),
  items: presupuesto
};
      if (presupuestoIdActual) {
        await updateDoc(doc(db, 'presupuestos', presupuestoIdActual), data);
        alert(`Presupuesto "${nombre}" actualizado.`);
      } else {
        const docRef = await addDoc(collection(db, 'presupuestos'), data);
        presupuestoIdActual = docRef.id;
        alert(`Presupuesto "${nombre}" guardado.`);
      }

      presupuesto = [];
      renderPresupuesto();
      nombrePresupuesto.value = '';
      presupuestoIdActual = null;
      cargarPresupuestosGuardados();
    });
let ordenSeleccionado = 'fecha-desc';

const toggleOrdenBtn = document.getElementById('toggle-orden');
const listaOrden = document.querySelector('#menu-orden .trabajos-lista');

toggleOrdenBtn.addEventListener('click', () => {
  listaOrden.classList.toggle('hidden');
});

document.querySelectorAll('input[name="orden"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    ordenSeleccionado = e.target.value;
    toggleOrdenBtn.textContent = `Orden: ${e.target.nextSibling.textContent.trim()}`;
    window.cargarPresupuestosGuardados(); // vuelve a cargar aplicando el nuevo orden
    listaOrden.classList.add('hidden');
  });
});
  window.cargarPresupuestosGuardados = async function () {
  const contenedor = document.getElementById('presupuestos-guardados');
  const snap = await getDocs(collection(db, 'presupuestos'));

    
let docs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    const imagenesSnap = await getDocs(collection(db, 'imagenes'));
const mapaImagenesPorPresupuesto = {};

imagenesSnap.forEach(doc => {
  const data = doc.data();
  (data.presupuestos || []).forEach(pid => {
    if (!mapaImagenesPorPresupuesto[pid]) {
      mapaImagenesPorPresupuesto[pid] = [];
    }
    mapaImagenesPorPresupuesto[pid].push(data.url);
  });
});

docs.sort((a, b) => {
  switch (ordenSeleccionado) {
   case 'fecha-asc': return new Date(a.fechaOrden) - new Date(b.fechaOrden);
case 'fecha-desc': return new Date(b.fechaOrden) - new Date(a.fechaOrden);
    case 'nombre-asc': return a.nombre.localeCompare(b.nombre);
    case 'nombre-desc': return b.nombre.localeCompare(a.nombre);
    case 'total-asc': return parseFloat(a.total) - parseFloat(b.total);
    case 'total-desc': return parseFloat(b.total) - parseFloat(a.total);
    default: return 0;
  }
});

 contenedor.innerHTML = `
    <h2>Presupuestos guardados</h2>
    <ul>
      ${docs.map(p => {
        const imagenes = mapaImagenesPorPresupuesto[p.id] || [];
        const htmlImagenes = imagenes.length
          ? `<div class="miniaturas">${imagenes.map(url => 
              `<img src="${url}" class="mini-imagen" onclick="abrirModal('${url}')" />`
            ).join('')}</div>`
          : '';

        return `
          <li class="item-presupuesto" id="presupuesto-${p.id}">
            <div class="datos-presu">
              <span class="nombre">${p.nombre}</span>
              <span class="fecha">${p.fecha}</span>
              <span class="total">Total: $<span class="monto">${formatearMoneda(parseFloat(p.total))}</span></span>
              ${htmlImagenes}
            </div>
            <div class="menu-wrapper">
              <button class="abrir-menu" data-id="${p.id}">Opciones</button>
              <div class="menu-acciones hidden" id="menu-${p.id}">
                <button onclick="consultarPresupuesto('${p.id}')">Ver / Editar</button>
                <button onclick="compartirPresupuesto('${p.id}')">Enviar por WhatsApp</button>
                <button onclick="eliminarPresupuesto('${p.id}')">Eliminar</button>
                <button onclick="refrescarPresupuesto('${p.id}')">üîÑ Refrescar</button>
                <button onclick="asignarImagenes('${p.id}')">üì∏ Asignar im√°genes</button>
              </div>
            </div>
          </li>
        `;
      }).join('')}
    </ul>
  `;
  setTimeout(() => {
    document.querySelectorAll('.abrir-menu').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const id = btn.dataset.id;
        const menu = document.getElementById(`menu-${id}`);
        document.querySelectorAll('.menu-acciones').forEach(m => {
          if (m !== menu) m.classList.add('hidden');
        });
        menu.classList.toggle('hidden');
      });
    });
  }, 0);

  window.addEventListener('click', () => {
    document.querySelectorAll('.menu-acciones').forEach(m => m.classList.add('hidden'));
  });
};

window.consultarPresupuesto = async (id) => {
  const snap = await getDocs(collection(db, 'presupuestos'));
  const materialesSnap = await getDocs(collection(db, 'materiales'));

  let p = null;
  snap.forEach(doc => {
    if (doc.id === id) p = { id: doc.id, ...doc.data() };
  });
  if (!p) return alert('Presupuesto no encontrado');

  // Obtener precios actualizados
  const preciosActuales = {};
  materialesSnap.forEach(doc => {
    const mat = doc.data();
    preciosActuales[mat.nombre] = mat.precio / mat.fraccionamiento;
  });

  let huboCambios = false;

  // Reemplazar precios y detectar diferencias
  presupuesto = p.items.map(item => {
    const nuevoPrecio = preciosActuales[item.nombre] || item.precioPorUnidad;
    const precioViejo = item.precioPorUnidad;
    const nuevoSubtotal = nuevoPrecio * item.cantidad * item.multiplicadorTotal;

    if (Math.abs(nuevoPrecio - precioViejo) > 0.01) {
      huboCambios = true;
    }

    return {
      ...item,
      precioPorUnidad: nuevoPrecio,
      subtotal: nuevoSubtotal
    };
  });

  nombrePresupuesto.value = p.nombre;
  presupuestoIdActual = p.id;
  renderPresupuesto();

  // Mostrar √≠cono seg√∫n haya o no cambios
  const iconoWrapper = document.createElement('div');
  iconoWrapper.style.display = 'flex';
  iconoWrapper.style.alignItems = 'center';

  const icono = document.createElement('i');
  if (huboCambios) {
    icono.setAttribute('data-lucide', 'refresh-ccw');
    icono.title = 'Precios actualizados';
    icono.style.color = '#f1c40f';
  } else {
    icono.setAttribute('data-lucide', 'check-circle');
    icono.title = 'Ya estaba actualizado';
    icono.style.color = '#2ecc71';
  }
  icono.style.opacity = '0.9';

  iconoWrapper.appendChild(icono);

  const wrapper = document.getElementById('nombre-wrapper');
  wrapper.appendChild(iconoWrapper);
  lucide.createIcons();

  setTimeout(() => {
    iconoWrapper.remove();
  }, 3000);
};

window.eliminarPresupuesto = async (id) => {
  if (!confirm("¬øSeguro que quer√©s eliminar este presupuesto?")) return;
  await deleteDoc(doc(db, 'presupuestos', id));
  alert("Presupuesto eliminado.");
  window.cargarPresupuestosGuardados();
};

window.compartirPresupuesto = async (id) => {
  const snap = await getDocs(collection(db, 'presupuestos'));
  let p = null;
  snap.forEach(doc => {
    if (doc.id === id) p = { id: doc.id, ...doc.data() };
  });
  if (!p) return alert('Presupuesto no encontrado');

const materiales = [...new Set(p.items.map(item => item.nombre))];
const totalRedondeado = redondearADecena(parseFloat(p.total));

const mensaje = `
--------------------------------------------------------------
üõ† *Presupuesto: ${p.nombre}*
_Fecha: ${p.fecha}_

üìã *Materiales:*
${materiales.map(m => `- _${m}_`).join('\n')}

üí∞ *Total:* *$${formatearMoneda(totalRedondeado)}*

_Gracias por tu consulta!!_
*Linda Herrer√≠a*
--------------------------------------------------------------
`.trim();
const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
  window.open(url, '_blank');
};
    await cargarTareas();
    await cargarMateriales();
    await window.cargarPresupuestosGuardados();
   
window.refrescarPresupuesto = async (id) => {
  const presupuestoSnap = await getDocs(collection(db, 'presupuestos'));
  const materialesSnap = await getDocs(collection(db, 'materiales'));

  const preciosActuales = {};
  materialesSnap.forEach(doc => {
    const mat = doc.data();
    preciosActuales[mat.nombre] = mat.precio / mat.fraccionamiento;
  });

  let presupuestoActual = null;
  presupuestoSnap.forEach(doc => {
    if (doc.id === id) presupuestoActual = { id: doc.id, ref: doc.ref, ...doc.data() };
  });

  if (!presupuestoActual) return alert('Presupuesto no encontrado.');

  let nuevoTotal = presupuestoActual.items.reduce((acc, item) => {
    const precio = preciosActuales[item.nombre] || item.precioPorUnidad;
    return acc + precio * item.cantidad * item.multiplicadorTotal;
  }, 0);

  nuevoTotal = redondearADecena(nuevoTotal); // ‚úÖ aplicar redondeo

  const totalAnterior = redondearADecena(parseFloat(presupuestoActual.total)); // ‚úÖ comparar redondeado

  if (nuevoTotal !== totalAnterior) {
    await updateDoc(presupuestoActual.ref, {
      total: nuevoTotal.toFixed(0) // ‚úÖ sin decimales
    });

    document.querySelector(`#presupuesto-${id} .monto`).textContent = formatearMoneda(nuevoTotal);
    alert(`Presupuesto "${presupuestoActual.nombre}" actualizado con nuevo total.`);
  } else {
    alert('‚úÖ El presupuesto ya est√° actualizado.');
  }
};
   window.asignarImagenes = (id) => {
  window.location.href = `galeria.html?presupuesto=${id}`;
};
  lucide.createIcons();
  </script>
<script>
function toggleMenu() {
  const menu = document.getElementById('menuOpciones');
  menu.classList.toggle('hidden');
  lucide.createIcons(); // <<<<<< ACTIVAR ICONOS
}

// Cerrar men√∫ si clicke√°s fuera
window.addEventListener('click', function(e) {
  const menu = document.getElementById('menuOpciones');
  const hamburguesa = document.querySelector('.menu-hamburguesa');
  
  // Si el clic no fue sobre el men√∫ ni sobre el bot√≥n hamburguesa
  if (!menu.contains(e.target) && !hamburguesa.contains(e.target)) {
    menu.classList.add('hidden');
  }
});
</script>

<style>
/* Estilos para el modal de im√°genes */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  padding-top: 50px;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.9);
}

.modal-contenido {
  margin: auto;
  display: block;
  max-width: 90%;
  max-height: 90vh;
  object-fit: contain;
}

.cerrar-modal {
  position: absolute;
  right: 35px;
  top: 15px;
  color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
}

.mini-imagen {
  cursor: pointer;
  transition: opacity 0.3s;
}

.mini-imagen:hover {
  opacity: 0.8;
}

/* Estilos para el contenedor de input y ayuda */
.input-ayuda-container {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  width: 100%;
}

#input-detalle {
  flex: 0.9; /* Ocupa el 90% del espacio disponible */
  min-width: 0; /* Permite que el input se encoja si es necesario */
  padding: 8px;
  border: 1px solid #34495e;
  border-radius: 4px;
  font-size: 14px;
  background-color: #2c3e50;
  color: #ecf0f1;
}

.boton-ayuda {
  flex: 0.1; /* Ocupa el 10% del espacio disponible */
  min-width: 32px; /* Asegura un tama√±o m√≠nimo para el √≠cono */
  height: 32px; /* Mantiene el bot√≥n cuadrado */
  background: none;
  border: none;
  color: #f39c12;
  cursor: pointer;
  padding: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  border-radius: 50%;
}

.boton-ayuda:hover {
  transform: scale(1.1);
  color: #f1c40f;
  background-color: rgba(255, 255, 255, 0.1);
}

/* Estilos para el modal de ayuda */
.modal-ayuda-contenido {
  background-color: #2c3e50;
  margin: auto;
  padding: 20px;
  border-radius: 8px;
  max-width: 800px;
  width: 90%;
  position: relative;
  color: #ecf0f1;
}

.ejemplos-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.ejemplo {
  background-color: #34495e;
  padding: 15px;
  border-radius: 6px;
  border-left: 4px solid #f39c12;
}

.ejemplo h4 {
  color: #f39c12;
  margin: 0 0 10px 0;
}

.ejemplo code {
  background-color: #2c3e50;
  padding: 4px 8px;
  border-radius: 4px;
  font-family: monospace;
  color: #e74c3c;
}

.ejemplo p {
  margin: 10px 0 0 0;
  color: #bdc3c7;
  font-size: 0.9em;
}

.alerta-decimal {
  margin-top: 20px;
  padding: 15px;
  background-color: #c0392b;
  border-radius: 6px;
  text-align: center;
  font-weight: bold;
}
</style>

<script>
// Funciones para el modal de im√°genes
window.abrirModal = function(url) {
  const modal = document.getElementById('imagen-modal');
  const imgAmpliada = document.getElementById('img-ampliada');
  imgAmpliada.src = url;
  modal.style.display = "block";
}

// Cerrar modal al hacer clic en la X
document.querySelector('.cerrar-modal').onclick = function() {
  document.getElementById('imagen-modal').style.display = "none";
}

// Cerrar modal al hacer clic fuera de la imagen
document.getElementById('imagen-modal').onclick = function(e) {
  if (e.target === this) {
    this.style.display = "none";
  }
}

// Cerrar modal con la tecla Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.getElementById('imagen-modal').style.display = "none";
  }
});

// Funciones para el modal de ayuda
window.mostrarAyudaExpresiones = function() {
  document.getElementById('ayuda-modal').style.display = "block";
}

window.cerrarAyudaExpresiones = function() {
  document.getElementById('ayuda-modal').style.display = "none";
}

// Cerrar modal de ayuda con Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.getElementById('ayuda-modal').style.display = "none";
    document.getElementById('imagen-modal').style.display = "none";
  }
});

// Cerrar modal de ayuda al hacer clic fuera
document.getElementById('ayuda-modal').onclick = function(e) {
  if (e.target === this) {
    this.style.display = "none";
  }
}
</script>
</body>
</html>

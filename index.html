<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Linda HerrerÃ­a - Presupuestos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Linda HerrerÃ­a</h2>

  <div style="text-align: center; margin-bottom: 20px;">
    <a href="cargar-materiales.html"><button>â• Cargar nuevo material</button></a>
    <a href="config-tareas.html"><button>âš™ï¸ Configurar tareas</button></a>
  </div>

  <input type="text" id="buscador" placeholder="Buscar material...">
  <div id="lista-materiales"></div>

  <hr>
  <h2>Presupuesto Actual</h2>
  <label>Nombre del presupuesto:
    <input type="text" id="nombre-presupuesto" placeholder="Ej: PortÃ³n Juan">
  </label>
  <button id="guardar-presupuesto">ğŸ’¾ Guardar presupuesto</button>

  <ul id="presupuesto"></ul>
  <p><strong>Total estimado: $<span id="total">0</span></strong></p>

  <div id="presupuestos-guardados"></div>

  <script type="module">
    import { db } from './firebase-config.js';
    import {
      collection, getDocs, addDoc, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    let trabajos = {};
    let materiales = [];
    let presupuesto = [];
    let presupuestoIdActual = null;

    const buscador = document.getElementById('buscador');
    const lista = document.getElementById('lista-materiales');
    const presupuestoUl = document.getElementById('presupuesto');
    const totalSpan = document.getElementById('total');
    const nombrePresupuesto = document.getElementById('nombre-presupuesto');
    const btnGuardar = document.getElementById('guardar-presupuesto');

    buscador.addEventListener('input', () => {
      const texto = buscador.value.toLowerCase();
      const filtrados = materiales.filter(m => m.nombre.toLowerCase().includes(texto));
      mostrarMateriales(filtrados);
    });

    async function cargarMateriales() {
      const snap = await getDocs(collection(db, 'materiales'));
      materiales = [];
      snap.forEach(doc => materiales.push({ id: doc.id, ...doc.data() }));
      mostrarMateriales(materiales);
    }

    async function cargarTareas() {
      const snap = await getDocs(collection(db, 'tareas'));
      trabajos = {};
      snap.forEach(doc => {
        const data = doc.data();
        trabajos[data.nombre] = data.multiplicador;
      });
    }

    function calcularTotalDesdeTexto(texto) {
      const partes = texto.split('+').join(',').split(/,|y/i).map(p => p.trim());
      let total = 0;
      for (let parte of partes) {
        const match = parte.match(/(\d+(?:[.,]\d+)?)\s*(?:x|de)?\s*(\d+(?:[.,]\d+)?)/i);
        if (match) {
          const cantidad = parseFloat(match[1].replace(',', '.'));
          const medida = parseFloat(match[2].replace(',', '.'));
          total += cantidad * medida;
        }
      }
      return total;
    }

    function mostrarMateriales(listaMat) {
      lista.innerHTML = '';

      listaMat.forEach((mat, index) => {
        const card = document.createElement('div');
        card.className = 'card';

        const trabajosInputs = Object.entries(trabajos).map(([nombre, mult]) => `
          <label>
            <input type="checkbox" class="check-trabajo" data-nombre="${nombre}" data-index="${index}">
            ${nombre} Ã— ${mult}
          </label>
        `).join('<br>');

        card.innerHTML = `
          <strong>${mat.nombre}</strong><br>
          ğŸ’µ $${mat.precio} total â€“ $${(mat.precio / mat.fraccionamiento).toFixed(2)} x unidad<br>
          ğŸ“ ${mat.descripcion || 'Sin descripciÃ³n'}<br>
          <input type="text" class="input-detalle" placeholder="Uso: 1 x 2, 2 x 1.5...">
          <details>
            <summary>âš™ï¸ Trabajos</summary>
            <div class="trabajos-lista">${trabajosInputs}</div>
          </details>
          <button class="btn-agregar">â• Agregar</button>
        `;

        const btn = card.querySelector('.btn-agregar');
        btn.addEventListener('click', () => {
          const texto = card.querySelector('.input-detalle').value.trim();
          if (!texto) return alert("âš ï¸ IngresÃ¡ el detalle de uso.");
          const cantidad = calcularTotalDesdeTexto(texto);
          if (!cantidad || isNaN(cantidad)) return alert("âš ï¸ No se pudo interpretar la cantidad.");

          const precioPorUnidad = mat.precio / mat.fraccionamiento;
          const checkboxes = card.querySelectorAll('.check-trabajo');

          let multiplicadorTotal = 0;
          let trabajosSeleccionados = [];

          checkboxes.forEach((check) => {
            if (check.checked) {
              const nombre = check.dataset.nombre;
              const mult = trabajos[nombre];
              multiplicadorTotal += mult;
              trabajosSeleccionados.push(`${nombre} Ã—${mult}`);
            }
          });

          if (multiplicadorTotal === 0) return alert("âš ï¸ SeleccionÃ¡ al menos un trabajo.");

          const subtotal = (precioPorUnidad * cantidad * multiplicadorTotal).toFixed(2);

          presupuesto.push({
            nombre: mat.nombre,
            unidad: mat.unidad,
            cantidad,
            precioPorUnidad: precioPorUnidad.toFixed(2),
            trabajos: trabajosSeleccionados,
            multiplicadorTotal: multiplicadorTotal.toFixed(2),
            subtotal: parseFloat(subtotal)
          });

          renderPresupuesto();
        });

        lista.appendChild(card);
      });
    }

    function renderPresupuesto() {
      presupuestoUl.innerHTML = '';
      let total = 0;

      presupuesto.forEach((item, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <strong>${item.nombre}</strong><br>
            Cantidad: ${item.cantidad.toFixed(2)} Ã— $${item.precioPorUnidad}/${item.unidad}<br>
            Trabajos: ${item.trabajos.join(', ') || 'Ninguno'}<br>
            Subtotal: $${item.subtotal}
          </div>
          <button onclick="eliminarItem(${i})">âŒ</button>
        `;
        presupuestoUl.appendChild(li);
        total += item.subtotal;
      });

      totalSpan.textContent = total.toFixed(2);
    }

    window.eliminarItem = (i) => {
      presupuesto.splice(i, 1);
      renderPresupuesto();
    };

    btnGuardar.addEventListener('click', async () => {
      const nombre = nombrePresupuesto.value.trim();
      if (!nombre) return alert('PonÃ© un nombre al presupuesto.');
      const fecha = new Date().toLocaleString();
      const total = totalSpan.textContent;

      const data = { nombre, fecha, total, items: presupuesto };

      if (presupuestoIdActual) {
        await updateDoc(doc(db, 'presupuestos', presupuestoIdActual), data);
        alert(`âœ… Presupuesto "${nombre}" actualizado.`);
      } else {
        const docRef = await addDoc(collection(db, 'presupuestos'), data);
        presupuestoIdActual = docRef.id;
        alert(`ğŸ’¾ Presupuesto "${nombre}" guardado.`);
      }

      presupuesto = [];
      renderPresupuesto();
      nombrePresupuesto.value = '';
      presupuestoIdActual = null;
      cargarPresupuestosGuardados();
    });

    async function cargarPresupuestosGuardados() {
      const contenedor = document.getElementById('presupuestos-guardados');
      const snap = await getDocs(collection(db, 'presupuestos'));
      const lista = [];
      snap.forEach(doc => lista.push({ id: doc.id, ...doc.data() }));

      contenedor.innerHTML = `
        <h2>Presupuestos guardados</h2>
        <ul>
          ${lista.map(p => `
            <li>
              <div class="info-presu">
                <strong>${p.nombre}</strong>
                <span>${p.fecha}</span>
                <span>Total: $${p.total}</span>
              </div>
              <div class="botones-presu">
                <button onclick="consultarPresupuesto('${p.id}')">ğŸ‘</button>
                <button onclick="compartirPresupuesto('${p.id}')">ğŸ“¤</button>
                <button onclick="eliminarPresupuesto('${p.id}')">ğŸ—‘</button>
              </div>
            </li>
          `).join('')}
        </ul>
      `;
    }

    window.consultarPresupuesto = async (id) => {
      const snap = await getDocs(collection(db, 'presupuestos'));
      let p = null;
      snap.forEach(doc => {
        if (doc.id === id) p = { id: doc.id, ...doc.data() };
      });
      if (!p) return alert('Presupuesto no encontrado');

      presupuesto = p.items;
      nombrePresupuesto.value = p.nombre;
      presupuestoIdActual = p.id;
      renderPresupuesto();
    };

    window.eliminarPresupuesto = async (id) => {
      await deleteDoc(doc(db, 'presupuestos', id));
      alert("ğŸ—‘ Presupuesto eliminado.");
      cargarPresupuestosGuardados();
    };

    window.compartirPresupuesto = async (id) => {
      const snap = await getDocs(collection(db, 'presupuestos'));
      let p = null;
      snap.forEach(doc => {
        if (doc.id === id) p = { id: doc.id, ...doc.data() };
      });
      if (!p) return alert('Presupuesto no encontrado');

      const materiales = [...new Set(p.items.map(item => item.nombre))].join(', ');
      const mensaje = `ğŸ“‹ *Presupuesto: ${p.nombre}*\nğŸ—“ ${p.fecha}\n\nğŸ”© Materiales: ${materiales}\n\nğŸ’° *Total: $${p.total}*`;
      const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    };

    await cargarTareas();
    await cargarMateriales();
    cargarPresupuestosGuardados();
  </script>
</body>
</html>

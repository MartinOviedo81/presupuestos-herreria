<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Linda Herrería - Presupuestos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Linda Herrería</h2>

  <div style="text-align: center; margin-bottom: 20px;">
    <a href="cargar-materiales.html" style="text-decoration: none;">
      <button style="width: auto; padding: 10px 20px;">➕ Cargar nuevo material</button>
    </a>
    <a href="config-tareas.html" style="text-decoration: none;">
      <button style="width: auto; padding: 10px 20px;">⚙️ Configurar tareas</button>
    </a>
  </div>

  <input type="text" id="buscador" placeholder="Buscar material...">
  <div id="lista-materiales"></div>

  <hr>
  <h2>Presupuesto Actual</h2>

  <div>
    <label>Nombre del presupuesto:
      <input type="text" id="nombre-presupuesto" placeholder="Ej: Portón Juan">
    </label>
    <button id="guardar-presupuesto">💾 Guardar presupuesto</button>
  </div>

  <ul id="presupuesto"></ul>
  <p><strong>Total estimado: $<span id="total">0</span></strong></p>

  <div id="presupuestos-guardados"></div>

  <script type="module">
    import { db } from './firebase-config.js';
    import {
      collection, getDocs, addDoc, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    let trabajos = {};
    let materiales = [];
    let presupuesto = [];
    let presupuestoIdActual = null;

    const buscador = document.getElementById('buscador');
    const lista = document.getElementById('lista-materiales');
    const presupuestoUl = document.getElementById('presupuesto');
    const totalSpan = document.getElementById('total');
    const nombrePresupuesto = document.getElementById('nombre-presupuesto');
    const btnGuardar = document.getElementById('guardar-presupuesto');

    buscador.addEventListener('input', () => {
      const texto = buscador.value.toLowerCase();
      const filtrados = materiales.filter(m => m.nombre.toLowerCase().includes(texto));
      mostrarMateriales(filtrados);
    });

    async function cargarMateriales() {
      const snap = await getDocs(collection(db, 'materiales'));
      materiales = [];
      snap.forEach(doc => materiales.push({ id: doc.id, ...doc.data() }));
      mostrarMateriales(materiales);
    }

    async function cargarTareas() {
      const snap = await getDocs(collection(db, 'tareas'));
      trabajos = {};
      snap.forEach(doc => {
        const data = doc.data();
        trabajos[data.nombre] = data.multiplicador;
      });
    }

    function calcularTotalDesdeTexto(texto) {
      const partes = texto.split('+').join(',').split(/,|y/i).map(p => p.trim());
      let total = 0;

      for (let parte of partes) {
        const match = parte.match(/(\d+(?:[.,]\d+)?)\s*(?:x|de)?\s*(\d+(?:[.,]\d+)?)/i);
        if (match) {
          const cantidad = parseFloat(match[1].replace(',', '.'));
          const medida = parseFloat(match[2].replace(',', '.'));
          total += cantidad * medida;
        }
      }

      return total;
    }

    function mostrarMateriales(listaMat) {
      lista.innerHTML = '';

      listaMat.forEach((mat, index) => {
        const card = document.createElement('div');
        card.className = 'card';

        const trabajosInputs = Object.entries(trabajos).map(([nombre, mult]) => `
          <label>
            <input type="checkbox" class="check-trabajo" data-nombre="${nombre}" data-index="${index}">
            ${nombre} × ${mult}
          </label>
        `).join('<br>');

        card.innerHTML = `
          <h4>${mat.nombre}</h4>
          <p><strong>Unidad:</strong> ${mat.unidad}</p>
          <p><strong>Precio total:</strong> $${mat.precio}</p>
          <p><strong>Fracción:</strong> ${mat.fraccionamiento} ${mat.unidad}</p>
          <p><strong>Precio por unidad:</strong> $${(mat.precio / mat.fraccionamiento).toFixed(2)}</p>
          <p><strong>Descripción:</strong> ${mat.descripcion || 'Sin descripción'}</p>
          <p><small>Actualizado: ${mat.fecha}</small></p>

          <label>Detalle de uso:
            <input type="text" class="input-detalle" placeholder="Ej: 2 de 3 metros y 3 de 1 metro">
          </label>

          <details>
            <summary>Trabajos a realizar</summary>
            <div class="trabajos-lista">${trabajosInputs}</div>
          </details>

          <button class="btn-agregar">Agregar al presupuesto</button>
        `;

        const btn = card.querySelector('.btn-agregar');
        btn.addEventListener('click', () => {
          const texto = card.querySelector('.input-detalle').value.trim();
          if (!texto) {
            alert("⚠️ Ingresá el detalle de uso para calcular la cantidad.");
            return;
          }

          const cantidad = calcularTotalDesdeTexto(texto);
          if (!cantidad || isNaN(cantidad)) {
            alert("⚠️ No se pudo interpretar la cantidad. Verificá el formato.");
            return;
          }

          const precioPorUnidad = mat.precio / mat.fraccionamiento;
          const checkboxes = card.querySelectorAll('.check-trabajo');

          let multiplicadorTotal = 0;
          let trabajosSeleccionados = [];

          checkboxes.forEach((check) => {
            if (check.checked) {
              const nombre = check.dataset.nombre;
              const mult = trabajos[nombre];
              multiplicadorTotal += mult;
              trabajosSeleccionados.push(`${nombre} ×${mult}`);
            }
          });

          if (multiplicadorTotal === 0) {
            alert("⚠️ Seleccioná al menos un trabajo para agregar el material al presupuesto.");
            return;
          }

          const subtotal = (precioPorUnidad * cantidad * multiplicadorTotal).toFixed(2);

          presupuesto.push({
            nombre: mat.nombre,
            unidad: mat.unidad,
            cantidad,
            precioPorUnidad: precioPorUnidad.toFixed(2),
            trabajos: trabajosSeleccionados,
            multiplicadorTotal: multiplicadorTotal.toFixed(2),
            subtotal: parseFloat(subtotal)
          });

          renderPresupuesto();
        });

        lista.appendChild(card);
      });
    }

    function renderPresupuesto() {
      presupuestoUl.innerHTML = '';
      let total = 0;

      presupuesto.forEach((item, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <strong>${item.nombre}</strong><br>
            Cantidad: ${item.cantidad.toFixed(2)} × $${item.precioPorUnidad}/${item.unidad}<br>
            Trabajos: ${item.trabajos.join(', ') || 'Ninguno'}<br>
            Multiplicador total: ${item.multiplicadorTotal}<br>
            Subtotal: $${item.subtotal}
          </div>
          <button onclick="eliminarItem(${i})">❌</button>
        `;
        presupuestoUl.appendChild(li);
        total += item.subtotal;
      });

      totalSpan.textContent = total.toFixed(2);
    }

    window.eliminarItem = (i) => {
      presupuesto.splice(i, 1);
      renderPresupuesto();
    };

    btnGuardar.addEventListener('click', async () => {
      const nombre = nombrePresupuesto.value.trim();
      if (!nombre) return alert('Poné un nombre al presupuesto.');

      const fecha = new Date().toLocaleString();
      const total = totalSpan.textContent;

      const data = {
        nombre,
        fecha,
        total,
        items: presupuesto
      };

      if (presupuestoIdActual) {
        await updateDoc(doc(db, 'presupuestos', presupuestoIdActual), data);
        alert(`✅ Presupuesto "${nombre}" actualizado.`);
      } else {
        const docRef = await addDoc(collection(db, 'presupuestos'), data);
        presupuestoIdActual = docRef.id;
        alert(`💾 Presupuesto "${nombre}" guardado.`);
      }

      presupuesto = [];
      renderPresupuesto();
      nombrePresupuesto.value = '';
      presupuestoIdActual = null;
      cargarPresupuestosGuardados();
    });

    async function cargarPresupuestosGuardados() {
      const contenedor = document.getElementById('presupuestos-guardados');
      const snap = await getDocs(collection(db, 'presupuestos'));
      const lista = [];
      snap.forEach(doc => lista.push({ id: doc.id, ...doc.data() }));

      contenedor.innerHTML = `
        <h2>Presupuestos guardados</h2>
        <ul>
          ${lista.map(p => `
            <li>
              <strong>${p.nombre}</strong> (${p.fecha}) - Total: $${p.total}<br>
              <button onclick="consultarPresupuesto('${p.id}')">👁 Ver / Editar</button>
              <button onclick="compartirPresupuesto('${p.id}')">📤 WhatsApp</button>
              <button onclick="eliminarPresupuesto('${p.id}')">🗑 Eliminar</button>
            </li>
          `).join('')}
        </ul>
      `;
    }

    window.consultarPresupuesto = async (id) => {
      const snap = await getDocs(collection(db, 'presupuestos'));
      let p = null;
      snap.forEach(doc => {
        if (doc.id === id) p = { id: doc.id, ...doc.data() };
      });
      if (!p) return alert('Presupuesto no encontrado');

      presupuesto = p.items;
      nombrePresupuesto.value = p.nombre;
      presupuestoIdActual = p.id;
      renderPresupuesto();

      alert(`✏️ Editando presupuesto "${p.nombre}". No olvides guardar los cambios.`);
    };

    window.eliminarPresupuesto = async (id) => {
      await deleteDoc(doc(db, 'presupuestos', id));
      alert("🗑 Presupuesto eliminado.");
      cargarPresupuestosGuardados();
    };

    window.compartirPresupuesto = async (id) => {
      const snap = await getDocs(collection(db, 'presupuestos'));
      let p = null;
      snap.forEach(doc => {
        if (doc.id === id) p = { id: doc.id, ...doc.data() };
      });
      if (!p) return alert('Presupuesto no encontrado');

      const materiales = [...new Set(p.items.map(item => item.nombre))].join(', ');
      const mensaje = `📋 *Presupuesto: ${p.nombre}*\n🗓 ${p.fecha}\n\n🔩 Materiales: ${materiales}\n\n💰 *Total: $${p.total}*`;
      const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    };

    // Carga inicial
    await cargarTareas();
    await cargarMateriales();
    cargarPresupuestosGuardados();
  </script>
</body>
</html>

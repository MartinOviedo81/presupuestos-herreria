<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Linda HerrerÃ­a - Presupuestos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Linda HerrerÃ­a</h2>
<div style="text-align: center; margin-bottom: 20px;">
  <a href="cargar-materiales.html" style="text-decoration: none;">
    <button style="width: auto; padding: 10px 20px;">â• Cargar nuevo material</button>
  </a>
</div>

  <input type="text" id="buscador" placeholder="Buscar material...">
  <div id="lista-materiales"></div>

  <hr>
  <h2>Presupuesto Actual</h2>

  <div>
    <label>Nombre del presupuesto:
      <input type="text" id="nombre-presupuesto" placeholder="Ej: PortÃ³n Juan">
    </label>
    <button id="guardar-presupuesto">ğŸ’¾ Guardar presupuesto</button>
  </div>

  <ul id="presupuesto"></ul>
  <p><strong>Total estimado: $<span id="total">0</span></strong></p>

  <div id="presupuestos-guardados"></div>

  <script type="module">
    import { db } from './firebase-config.js';
    import {
      collection, getDocs, addDoc, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const trabajosBase = {
      'corte y soldadura': 2.5,
      'rolado': 0.5,
      'doblado': 0.5,
      'enderezado': 0.5,
      'pintura': 0.25,
      'instalaciÃ³n': 0.25,
      'embalaje': 0.1,
      'flete': 0.3
    };

    let trabajos = { ...trabajosBase };
    let materiales = [];
    let presupuesto = [];
    let presupuestoIdActual = null;

    const buscador = document.getElementById('buscador');
    const lista = document.getElementById('lista-materiales');
    const presupuestoUl = document.getElementById('presupuesto');
    const totalSpan = document.getElementById('total');
    const nombrePresupuesto = document.getElementById('nombre-presupuesto');
    const btnGuardar = document.getElementById('guardar-presupuesto');

    buscador.addEventListener('input', () => {
      const texto = buscador.value.toLowerCase();
      const filtrados = materiales.filter(m => m.nombre.toLowerCase().includes(texto));
      mostrarMateriales(filtrados);
    });

    async function cargarMateriales() {
      const snap = await getDocs(collection(db, 'materiales'));
      materiales = [];
      snap.forEach(doc => materiales.push(doc.data()));
      mostrarMateriales(materiales);
    }

    function mostrarMateriales(listaMat) {
      lista.innerHTML = '';

      listaMat.forEach((mat, index) => {
        const card = document.createElement('div');
        card.className = 'card';

        const trabajosInputs = Object.entries(trabajos).map(([nombre, mult]) => `
          <label>
            <input type="checkbox" class="check-trabajo" data-nombre="${nombre}" data-index="${index}">
            ${nombre}
            <input type="number" value="${mult}" class="input-multiplicador" step="0.1" min="0.1" data-nombre="${nombre}" data-index="${index}" style="width: 60px;">Ã—
          </label>
        `).join('<br>');

        card.innerHTML = `
          <h4>${mat.nombre}</h4>
          <p>Precio barra: $${mat.precio}</p>
          <p>Largo: ${mat.largo}</p>

          <label>Metros a usar:
            <input type="number" min="0.1" step="0.1" value="1" class="input-metros">
          </label>

          <details>
            <summary>Trabajos a realizar</summary>
            <div class="trabajos-lista">${trabajosInputs}</div>
          </details>

          <button class="btn-agregar">Agregar al presupuesto</button>
        `;

        const btn = card.querySelector('.btn-agregar');
        btn.addEventListener('click', () => {
          const metros = parseFloat(card.querySelector('.input-metros').value);
          const largo = parseFloat(mat.largo.split(' ')[0]);
          const precioPorMetro = mat.precio / largo;
          const checkboxes = card.querySelectorAll('.check-trabajo');
          const multiplicadoresInputs = card.querySelectorAll('.input-multiplicador');

          let multiplicadorTotal = 0;
          let trabajosSeleccionados = [];

          checkboxes.forEach((check, i) => {
            if (check.checked) {
              const nombre = check.dataset.nombre;
              const mult = parseFloat(multiplicadoresInputs[i].value);
              multiplicadorTotal += mult;
              trabajosSeleccionados.push(`${nombre} Ã—${mult}`);
            }
          });

          if (multiplicadorTotal === 0) {
            alert("âš ï¸ SeleccionÃ¡ al menos un trabajo para agregar el material al presupuesto.");
            return;
          }

          const subtotal = (precioPorMetro * metros * multiplicadorTotal).toFixed(2);

          presupuesto.push({
            nombre: mat.nombre,
            metros,
            precioPorMetro: precioPorMetro.toFixed(2),
            trabajos: trabajosSeleccionados,
            multiplicadorTotal: multiplicadorTotal.toFixed(2),
            subtotal: parseFloat(subtotal)
          });

          renderPresupuesto();
        });

        lista.appendChild(card);
      });
    }

    function renderPresupuesto() {
      presupuestoUl.innerHTML = '';
      let total = 0;

      presupuesto.forEach((item, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <strong>${item.nombre}</strong><br>
            Metros: ${item.metros} m Ã— $${item.precioPorMetro}/m<br>
            Trabajos: ${item.trabajos.join(', ') || 'Ninguno'}<br>
            Multiplicador total: ${item.multiplicadorTotal}<br>
            Subtotal: $${item.subtotal}
          </div>
          <button onclick="eliminarItem(${i})">âŒ</button>
        `;
        presupuestoUl.appendChild(li);
        total += item.subtotal;
      });

      totalSpan.textContent = total.toFixed(2);
    }

    window.eliminarItem = (i) => {
      presupuesto.splice(i, 1);
      renderPresupuesto();
    };

    btnGuardar.addEventListener('click', async () => {
      const nombre = nombrePresupuesto.value.trim();
      if (!nombre) return alert('PonÃ© un nombre al presupuesto.');

      const fecha = new Date().toLocaleString();
      const total = totalSpan.textContent;

      const data = {
        nombre,
        fecha,
        total,
        items: presupuesto
      };

      if (presupuestoIdActual) {
        await updateDoc(doc(db, 'presupuestos', presupuestoIdActual), data);
        alert(`âœ… Presupuesto "${nombre}" actualizado.`);
      } else {
        const docRef = await addDoc(collection(db, 'presupuestos'), data);
        presupuestoIdActual = docRef.id;
        alert(`ğŸ’¾ Presupuesto "${nombre}" guardado.`);
      }

      presupuesto = [];
      renderPresupuesto();
      nombrePresupuesto.value = '';
      presupuestoIdActual = null;
      cargarPresupuestosGuardados();
    });

    async function cargarPresupuestosGuardados() {
      const contenedor = document.getElementById('presupuestos-guardados');
      const snap = await getDocs(collection(db, 'presupuestos'));
      const lista = [];
      snap.forEach(doc => lista.push({ id: doc.id, ...doc.data() }));

      contenedor.innerHTML = `
        <h2>Presupuestos guardados</h2>
        <ul>
          ${lista.map(p => `
            <li>
              <strong>${p.nombre}</strong> (${p.fecha}) - Total: $${p.total}<br>
              <button onclick="consultarPresupuesto('${p.id}')">ğŸ‘ Ver / Editar</button>
              <button onclick="compartirPresupuesto('${p.id}')">ğŸ“¤ WhatsApp</button>
              <button onclick="eliminarPresupuesto('${p.id}')">ğŸ—‘ Eliminar</button>
            </li>
          `).join('')}
        </ul>
      `;
    }

    window.consultarPresupuesto = async (id) => {
      const snap = await getDocs(collection(db, 'presupuestos'));
      let p = null;
      snap.forEach(doc => {
        if (doc.id === id) p = { id: doc.id, ...doc.data() };
      });
      if (!p) return alert('Presupuesto no encontrado');

      presupuesto = p.items;
      nombrePresupuesto.value = p.nombre;
      presupuestoIdActual = p.id;
      renderPresupuesto();

      alert(`âœï¸ Editando presupuesto "${p.nombre}". No olvides guardar los cambios.`);
    };

    window.eliminarPresupuesto = async (id) => {
      await deleteDoc(doc(db, 'presupuestos', id));
      alert("ğŸ—‘ Presupuesto eliminado.");
      cargarPresupuestosGuardados();
    };

    window.compartirPresupuesto = async (id) => {
      const snap = await getDocs(collection(db, 'presupuestos'));
      let p = null;
      snap.forEach(doc => {
        if (doc.id === id) p = { id: doc.id, ...doc.data() };
      });
      if (!p) return alert('Presupuesto no encontrado');

      const materiales = [...new Set(p.items.map(item => item.nombre))].join(', ');
      const mensaje = `ğŸ“‹ *Presupuesto: ${p.nombre}*\nğŸ—“ ${p.fecha}\n\nğŸ”© Materiales: ${materiales}\n\nğŸ’° *Total: $${p.total}*`;
      const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
    };

    cargarMateriales();
    cargarPresupuestosGuardados();
  </script>
</body>
</html>

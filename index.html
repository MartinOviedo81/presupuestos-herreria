<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Presupuesto de Herrer√≠a</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Presupuesto de Herrer√≠a</h2>

  <input type="text" id="buscador" placeholder="Buscar material...">

  <div id="lista-materiales"></div>

  <hr>

  <h2>Presupuesto Actual</h2>

  <div>
    <label>Nombre del presupuesto:
      <input type="text" id="nombre-presupuesto" placeholder="Ej: Port√≥n Juan">
    </label>
    <button id="guardar-presupuesto">üíæ Guardar presupuesto</button>
  </div>

  <ul id="presupuesto"></ul>
  <p><strong>Total estimado: $<span id="total">0</span></strong></p>

  <script type="module">
    import { db } from './firebase-config.js';
    import {
      collection, getDocs, addDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const trabajosBase = {
      'corte y soldadura': 2.5,
      'rolado': 3.5,
      'doblado': 1.5,
      'enderezado': 1.2,
      'pintura': 2,
      'instalaci√≥n': 3,
      'embalaje': 1.1
    };

    let trabajos = { ...trabajosBase };
    let materiales = [];
    let presupuesto = [];

    const buscador = document.getElementById('buscador');
    const lista = document.getElementById('lista-materiales');
    const presupuestoUl = document.getElementById('presupuesto');
    const totalSpan = document.getElementById('total');
    const nombrePresupuesto = document.getElementById('nombre-presupuesto');
    const btnGuardar = document.getElementById('guardar-presupuesto');

    buscador.addEventListener('input', () => {
      const texto = buscador.value.toLowerCase();
      const filtrados = materiales.filter(m => m.nombre.toLowerCase().includes(texto));
      mostrarMateriales(filtrados);
    });

    async function cargarMateriales() {
      const snap = await getDocs(collection(db, 'materiales'));
      materiales = [];
      snap.forEach(doc => materiales.push(doc.data()));
      mostrarMateriales(materiales);
    }

    function mostrarMateriales(listaMat) {
      lista.innerHTML = '';

      listaMat.forEach((mat, index) => {
        const card = document.createElement('div');
        card.className = 'card';

        const trabajosInputs = Object.entries(trabajos).map(([nombre, mult]) => `
          <label>
            <input type="checkbox" class="check-trabajo" data-nombre="${nombre}" data-index="${index}">
            ${nombre}
            <input type="number" value="${mult}" class="input-multiplicador" step="0.1" min="1" data-nombre="${nombre}" data-index="${index}" style="width: 60px;">√ó
          </label>
        `).join('<br>');

        card.innerHTML = `
          <h4>${mat.nombre}</h4>
          <p>Precio barra: $${mat.precio}</p>
          <p>Largo: ${mat.largo}</p>

          <label>Metros a usar:
            <input type="number" min="0.1" step="0.1" value="1" class="input-metros">
          </label>

          <details>
            <summary>Trabajos a realizar</summary>
            <div class="trabajos-lista">${trabajosInputs}</div>
          </details>

          <button class="btn-agregar">Agregar al presupuesto</button>
        `;

        const btn = card.querySelector('.btn-agregar');
btn.addEventListener('click', () => {
  const metros = parseFloat(card.querySelector('.input-metros').value);
  const largo = parseFloat(mat.largo.split(' ')[0]); // "6 mts" ‚Üí 6
  const precioPorMetro = mat.precio / largo;
  const checkboxes = card.querySelectorAll('.check-trabajo');
  const multiplicadoresInputs = card.querySelectorAll('.input-multiplicador');

  let multiplicadorTotal = 1; // el precio base ya cuenta como 1
  let trabajosSeleccionados = [];

  checkboxes.forEach((check, i) => {
    if (check.checked) {
      const nombre = check.dataset.nombre;
      const mult = parseFloat(multiplicadoresInputs[i].value);
      multiplicadorTotal += mult; // se suma directamente, sin agregar otro 1
      trabajosSeleccionados.push(`${nombre} √ó${mult}`);
    }
  });

  const subtotal = (precioPorMetro * metros * multiplicadorTotal).toFixed(2);

  presupuesto.push({
    nombre: mat.nombre,
    metros,
    precioPorMetro: precioPorMetro.toFixed(2),
    trabajos: trabajosSeleccionados,
    multiplicadorTotal: multiplicadorTotal.toFixed(2),
    subtotal: parseFloat(subtotal)
  });

  renderPresupuesto();
});

        lista.appendChild(card);
      });
    }

    function renderPresupuesto() {
      presupuestoUl.innerHTML = '';
      let total = 0;

      presupuesto.forEach((item, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <strong>${item.nombre}</strong><br>
            Metros: ${item.metros} m √ó $${item.precioPorMetro}/m<br>
            Trabajos: ${item.trabajos.join(', ') || 'Ninguno'}<br>
            Multiplicador total: ${item.multiplicadorTotal}<br>
            Subtotal: $${item.subtotal}
          </div>
          <button onclick="eliminarItem(${i})">‚ùå</button>
        `;
        presupuestoUl.appendChild(li);
        total += item.subtotal;
      });

      totalSpan.textContent = total.toFixed(2);
    }

    window.eliminarItem = (i) => {
      presupuesto.splice(i, 1);
      renderPresupuesto();
    };

    btnGuardar.addEventListener('click', () => {
      const nombre = nombrePresupuesto.value.trim();
      if (!nombre) return alert('Pon√© un nombre al presupuesto.');

      const fecha = new Date().toLocaleString();
      const total = totalSpan.textContent;

      const data = {
        nombre,
        fecha,
        total,
        items: presupuesto
      };

      const listaGuardados = JSON.parse(localStorage.getItem('presupuestos') || '[]');
      listaGuardados.push(data);
      localStorage.setItem('presupuestos', JSON.stringify(listaGuardados));

      alert(`üíæ Presupuesto "${nombre}" guardado.`);
      presupuesto = [];
      renderPresupuesto();
      nombrePresupuesto.value = '';
    });

    cargarMateriales();
  </script>
</body>
</html>

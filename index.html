<body class="modo-oscuro">
  <h2>Linda HerrerÃ­a</h2>

  <!-- ... MenÃº, categorÃ­as, carrusel, selecciÃ³n de materiales, etc. ... -->

  <hr />
  <h2>Presupuesto Actual</h2>
  <input type="text" id="nombre-presupuesto" placeholder="Nombre presupuesto" />

  <!-- INPUTS DE IMÃGENES -->
  <label style="margin-top: 1rem; display: block;">Imagen 1 (opcional)</label>
  <input type="file" id="imagen1-presupuesto" accept="image/*" />

  <label style="margin-top: 1rem; display: block;">Imagen 2 (opcional)</label>
  <input type="file" id="imagen2-presupuesto" accept="image/*" />

  <button id="guardar-presupuesto" class="boton-naranja">Guardar presupuesto</button>

  <ul id="presupuesto"></ul>
  <p><strong>Total estimado: $<span id="total">0</span></strong></p>

  <div id="presupuestos-guardados"></div>

  <!-- Firebase + lÃ³gica -->
  <script type="module">
    import { db, storage } from './firebase-config.js';
    import {
      collection, getDocs, addDoc, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import {
      ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

    // ... tus otras funciones como cargarMateriales, renderSeleccion, etc. ...

    const btnGuardar = document.getElementById('guardar-presupuesto');
    const totalSpan = document.getElementById('total');
    const nombrePresupuesto = document.getElementById('nombre-presupuesto');
    let presupuesto = [];
    let presupuestoIdActual = null;

    btnGuardar.addEventListener('click', async () => {
      const nombre = nombrePresupuesto.value.trim();
      if (!nombre) return alert('PonÃ© un nombre al presupuesto.');

      const archivo1 = document.getElementById('imagen1-presupuesto').files[0];
      const archivo2 = document.getElementById('imagen2-presupuesto').files[0];
      let imagenes = [];

      const subirImagen = async (archivo) => {
        const refImagen = ref(storage, `presupuestos/${Date.now()}_${archivo.name}`);
        const snap = await uploadBytes(refImagen, archivo);
        return await getDownloadURL(snap.ref);
      };

      if (archivo1) imagenes.push(await subirImagen(archivo1));
      if (archivo2) imagenes.push(await subirImagen(archivo2));

      const fechaActual = new Date();
      const data = {
        nombre,
        fecha: fechaActual.toLocaleDateString('es-AR'),
        fechaOrden: fechaActual.toISOString(),
        total: redondearADecena(parseFloat(totalSpan.textContent.replace(/\./g, ''))).toFixed(0),
        items: presupuesto,
        imagenes
      };

      if (presupuestoIdActual) {
        await updateDoc(doc(db, 'presupuestos', presupuestoIdActual), data);
        alert(`Presupuesto "${nombre}" actualizado.`);
      } else {
        const docRef = await addDoc(collection(db, 'presupuestos'), data);
        presupuestoIdActual = docRef.id;
        alert(`Presupuesto "${nombre}" guardado.`);
      }

      presupuesto = [];
      renderPresupuesto();
      nombrePresupuesto.value = '';
      presupuestoIdActual = null;
      cargarPresupuestosGuardados();
    });

    window.cargarPresupuestosGuardados = async function () {
      const contenedor = document.getElementById('presupuestos-guardados');
      const snap = await getDocs(collection(db, 'presupuestos'));
      const docs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      contenedor.innerHTML = `
        <h2>Presupuestos guardados</h2>
        <ul>
          ${docs.map(p => `
            <li class="item-presupuesto" id="presupuesto-${p.id}">
              <div class="datos-presu">
                <span class="nombre">${p.nombre}</span>
                <span class="fecha">${p.fecha}</span>
                <span class="total">Total: $<span class="monto">${formatearMoneda(parseFloat(p.total))}</span></span>
              </div>

              ${(p.imagenes || []).map(url => `
                <a href="${url}" target="_blank">
                  <img src="${url}" alt="Imagen presupuesto" style="width: 100px; border-radius: 6px; margin: 10px 0;">
                </a>
              `).join('')}

              <div class="menu-wrapper">
                <button class="abrir-menu" data-id="${p.id}">Opciones</button>
                <div class="menu-acciones hidden" id="menu-${p.id}">
                  <button onclick="consultarPresupuesto('${p.id}')">Ver / Editar</button>
                  <button onclick="compartirPresupuesto('${p.id}')">Enviar por WhatsApp</button>
                  <button onclick="eliminarPresupuesto('${p.id}')">Eliminar</button>
                  <button onclick="refrescarPresupuesto('${p.id}')">ðŸ”„ Refrescar</button>
                </div>
              </div>
            </li>
          `).join('')}
        </ul>
      `;

      // Opcional: lÃ³gica para botones de opciones
      setTimeout(() => {
        document.querySelectorAll('.abrir-menu').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = btn.dataset.id;
            const menu = document.getElementById(`menu-${id}`);
            document.querySelectorAll('.menu-acciones').forEach(m => {
              if (m !== menu) m.classList.add('hidden');
            });
            menu.classList.toggle('hidden');
          });
        });
      }, 0);
    };

    function formatearMoneda(valor) {
      return Math.round(valor).toLocaleString('es-AR');
    }

    function redondearADecena(valor) {
      return Math.round(valor / 100) * 100;
    }

    await window.cargarPresupuestosGuardados();
  </script>
</body>
